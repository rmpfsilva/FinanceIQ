<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Manager - Complete Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0B0F19;
            --bg-medium: #141824;
            --bg-card: #1C2333;
            --accent-green: #00FFA3;
            --accent-blue: #0099FF;
            --accent-red: #FF4757;
            --accent-yellow: #FFD93D;
            --text-primary: #F7F9FC;
            --text-secondary: #9BA4B5;
            --border: #2A3142;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Manrope', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .app {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-medium);
            border-right: 1px solid var(--border);
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            padding: 0 2rem 2rem;
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-item {
            padding: 1rem 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .nav-item:hover {
            background: rgba(0, 255, 163, 0.05);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(0, 255, 163, 0.1);
            border-left-color: var(--accent-green);
            color: var(--accent-green);
        }

        /* Main Content */
        .main {
            margin-left: 280px;
            flex: 1;
            padding: 0;
            max-width: 1800px;
        }

        /* Top Header Bar */
        .top-header {
            background: var(--bg-medium);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .top-header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .top-header-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .top-header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: rgba(0, 255, 163, 0.1);
            border: 1px solid rgba(0, 255, 163, 0.3);
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--accent-green);
        }

        .main-content {
            padding: 2rem;
        }

        .page-header {
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-title {
            font-size: 2.25rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 1.05rem;
        }

        /* Month/Year Selector */
        .month-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .month-btn {
            padding: 0.625rem 1.25rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .month-btn:hover {
            border-color: var(--accent-green);
            color: var(--text-primary);
        }

        .month-btn.active {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: var(--bg-dark);
        }

        .year-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .year-btn {
            padding: 0.75rem 1.5rem;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 700;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .year-btn:hover {
            border-color: var(--accent-green);
        }

        .year-btn.active {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: var(--bg-dark);
        }

        /* Cards */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-green);
            box-shadow: 0 20px 40px rgba(0, 255, 163, 0.1);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            font-family: 'IBM Plex Mono', monospace;
            margin-bottom: 0.5rem;
        }

        /* Buttons */
        .btn {
            padding: 0.875rem 1.75rem;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Manrope', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            color: var(--bg-dark);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 163, 0.3);
        }

        .btn-secondary {
            background: var(--bg-medium);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        /* Tables */
        .data-table {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .data-table thead {
            background: var(--bg-medium);
        }

        .data-table th {
            padding: 1rem 1.5rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
        }

        .data-table td {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
        }

        .data-table tr:hover {
            background: rgba(0, 255, 163, 0.03);
        }

        /* Checkbox styling */
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent-green);
        }

        /* Form inputs and textarea */
        input[type="text"],
        input[type="number"],
        input[type="password"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="password"]:focus,
        input[type="date"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(0, 255, 163, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Paid badge */
        .badge-paid {
            background: rgba(0, 255, 163, 0.2);
            color: var(--accent-green);
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-unpaid {
            background: rgba(255, 71, 87, 0.2);
            color: var(--accent-red);
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Chart Card */
        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }

        /* Forms */
        input, select {
            padding: 0.875rem 1rem;
            background: var(--bg-medium);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'Manrope', sans-serif;
            font-size: 0.95rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Utilities */
        .hidden { display: none !important; }
        .mb-2 { margin-bottom: 2rem; }
        .mt-2 { margin-top: 2rem; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .modal-title {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .close-btn {
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.3s ease;
            line-height: 1;
        }

        .close-btn:hover {
            color: var(--accent-red);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main { margin-left: 0; padding: 1rem; }
        }
    </style>
    <!-- Cloud Authentication & Features -->
    <script>
        console.log('üîê Initializing FinanceIQ Cloud Edition...');
        
        let db, currentUser;
        
        // Initialize Supabase and check authentication
        (async function initAuth() {
            try {
                // Wait for Supabase library to load
                let attempts = 0;
                while (typeof window.supabase === 'undefined' && attempts < 50) {
                    await new Promise(r => setTimeout(r, 100));
                    attempts++;
                }
                
                if (typeof window.supabase === 'undefined') {
                    console.error('Failed to load Supabase');
                    alert('Authentication system failed to load. Please refresh the page.');
                    return;
                }
                
                // Create Supabase client
                db = window.supabase.createClient(
                    'https://jtauixqxbaiceqsvyvoe.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0YXVpeHF4YmFpY2Vxc3Z5dm9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTk1MzksImV4cCI6MjA4MzI5NTUzOX0.kAJ07FbEmj884Dt48c8F1ktWIDPZ_G6--TW3WhbSxoY'
                );
                
                // Check if user is authenticated
                const { data: { user }, error } = await db.auth.getUser();
                
                if (error || !user) {
                    console.log('Not authenticated, redirecting to login...');
                    window.location.href = '/login.html';
                    return;
                }
                
                currentUser = user;
                console.log('‚úÖ Authenticated as:', user.email);
                console.log('‚úÖ FinanceIQ Cloud Edition Ready!');
                
                // Initialize Cloud Storage
                if (typeof CloudStorage !== 'undefined') {
                    setTimeout(() => CloudStorage.init(), 1000);
                }
                
                // Function to update all user email displays
                function updateUserEmailDisplays() {
                    if (!currentUser) return;
                    
                    // Update header email
                    const headerEmail = document.getElementById('header-user-email');
                    if (headerEmail) {
                        headerEmail.textContent = currentUser.email;
                    }
                    
                    // Update Settings page email
                    const settingsEmail = document.getElementById('current-user-email');
                    if (settingsEmail) {
                        settingsEmail.textContent = currentUser.email;
                    }
                }
                
                // Display user email when DOM loads
                window.addEventListener('DOMContentLoaded', updateUserEmailDisplays);
                
                // Also try immediately in case DOM is already loaded
                setTimeout(updateUserEmailDisplays, 1000);
                setTimeout(updateUserEmailDisplays, 2000);
                
            } catch (error) {
                console.error('Authentication error:', error);
                alert('Authentication failed. Please try again.');
                window.location.href = '/login.html';
            }
        })();
        
        // ========================================
        // CLOUD STORAGE MANAGER
        // ========================================
        // Hybrid approach: Save to BOTH localStorage (fast) and Supabase (cloud sync)
        
        const CloudStorage = {
            enabled: true,
            savingIndicator: null,
            
            // Initialize
            init: function() {
                console.log('‚òÅÔ∏è Cloud Storage System initialized');
                this.createSavingIndicator();
                
                // Check for data migration
                this.checkForMigration();
            },
            
            // Create saving indicator UI
            createSavingIndicator: function() {
                const indicator = document.createElement('div');
                indicator.id = 'cloud-save-indicator';
                indicator.style.cssText = `
                    position: fixed !important;
                    bottom: 20px !important;
                    right: 20px !important;
                    top: auto !important;
                    left: auto !important;
                    padding: 0.75rem 1.25rem;
                    background: rgba(0, 255, 163, 0.1);
                    border: 1px solid rgba(0, 255, 163, 0.3);
                    border-radius: 8px;
                    color: #00FFA3;
                    font-size: 0.9rem;
                    font-weight: 600;
                    display: none;
                    z-index: 99999;
                    transition: all 0.3s ease;
                `;
                document.body.appendChild(indicator);
                this.savingIndicator = indicator;
            },
            
            // Show saving status
            showStatus: function(message, type = 'saving') {
                if (!this.savingIndicator) return;
                
                this.savingIndicator.textContent = message;
                this.savingIndicator.style.display = 'block';
                
                if (type === 'success') {
                    this.savingIndicator.style.background = 'rgba(0, 255, 163, 0.1)';
                    this.savingIndicator.style.borderColor = 'rgba(0, 255, 163, 0.3)';
                    this.savingIndicator.style.color = '#00FFA3';
                } else if (type === 'error') {
                    this.savingIndicator.style.background = 'rgba(255, 71, 87, 0.1)';
                    this.savingIndicator.style.borderColor = 'rgba(255, 71, 87, 0.3)';
                    this.savingIndicator.style.color = '#FF6B6B';
                }
                
                // Auto-hide after 2 seconds
                if (type !== 'saving') {
                    setTimeout(() => {
                        this.savingIndicator.style.display = 'none';
                    }, 2000);
                }
            },
            
            // Save data to cloud
            saveToCloud: async function(key, value) {
                if (!this.enabled || !db || !currentUser) return false;
                
                try {
                    // Parse JSON string to object for JSONB storage
                    let jsonValue;
                    if (typeof value === 'string') {
                        try {
                            jsonValue = JSON.parse(value);
                        } catch (e) {
                            // If not valid JSON, store as-is wrapped in object
                            jsonValue = { data: value };
                        }
                    } else {
                        jsonValue = value;
                    }
                    
                    const { error } = await db
                        .from('user_settings')
                        .upsert({
                            user_id: currentUser.id,
                            key: key,
                            value: jsonValue,
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id,key'
                        });
                    
                    if (error) throw error;
                    console.log(`‚òÅÔ∏è Saved to cloud: ${key}`);
                    return true;
                    
                } catch (error) {
                    console.error(`‚ùå Cloud save failed for ${key}:`, error);
                    return false;
                }
            },
            
            // Load data from cloud
            loadFromCloud: async function(key) {
                if (!this.enabled || !db || !currentUser) return null;
                
                try {
                    // RLS automatically filters by user_id, don't add .eq('user_id')
                    const { data, error } = await db
                        .from('user_settings')
                        .select('value')
                        .eq('key', key)
                        .single();
                    
                    if (error) {
                        if (error.code === 'PGRST116') {
                            console.log(`‚ÑπÔ∏è No cloud data for: ${key}`);
                            return null;
                        }
                        throw error;
                    }
                    
                    console.log(`‚òÅÔ∏è Loaded from cloud: ${key}`);
                    
                    // Convert JSONB back to string for localStorage compatibility
                    if (typeof data.value === 'object') {
                        return JSON.stringify(data.value);
                    }
                    return data.value;
                    
                } catch (error) {
                    console.error(`‚ùå Cloud load failed for ${key}:`, error);
                    return null;
                }
            },
            
            // Hybrid save: localStorage + cloud
            save: async function(key, value) {
                // Save to localStorage immediately (fast)
                localStorage.setItem(key, value);
                
                // Save to cloud in background
                this.showStatus('‚òÅÔ∏è Saving...', 'saving');
                const success = await this.saveToCloud(key, value);
                
                if (success) {
                    this.showStatus('‚úì Saved', 'success');
                } else {
                    this.showStatus('‚ö† Local only', 'error');
                }
            },
            
            // Hybrid load: Try cloud first, fallback to localStorage
            load: async function(key) {
                // Try cloud first
                const cloudValue = await this.loadFromCloud(key);
                
                if (cloudValue) {
                    // Also update localStorage with cloud value
                    localStorage.setItem(key, cloudValue);
                    return cloudValue;
                }
                
                // Fallback to localStorage
                return localStorage.getItem(key);
            },
            
            // Check if migration is needed
            checkForMigration: async function() {
                // Check if localStorage has data but cloud doesn't
                const localFinanceData = localStorage.getItem('financeData');
                
                if (localFinanceData) {
                    const cloudData = await this.loadFromCloud('financeData');
                    
                    if (!cloudData) {
                        console.log('üì¶ Local data found, migration available');
                        // Show migration prompt in Settings
                        setTimeout(() => {
                            const migrationPrompt = document.getElementById('migration-prompt');
                            if (migrationPrompt) {
                                migrationPrompt.style.display = 'block';
                            }
                        }, 2000);
                    }
                }
            },
            
            // Migrate localStorage to cloud
            migrateToCloud: async function() {
                console.log('üîÑ Starting migration to cloud...');
                this.showStatus('üîÑ Migrating data...', 'saving');
                
                const keysToMigrate = [
                    { key: 'financeData', name: 'Finance Data' },
                    { key: 'recurringExpenses', name: 'Recurring Expenses' },
                    { key: 'debtHistory', name: 'Debt History' },
                    { key: 'financialGoals', name: 'Financial Goals' },
                    { key: 'budgets', name: 'Budgets' },
                    { key: 'personalProfile', name: 'Personal Profile' },
                    { key: 'openaiKey', name: 'OpenAI API Key' }
                ];
                
                let migratedItems = [];
                let failedItems = [];
                
                for (const item of keysToMigrate) {
                    const value = localStorage.getItem(item.key);
                    if (value) {
                        const success = await this.saveToCloud(item.key, value);
                        if (success) {
                            migratedItems.push(item.name);
                        } else {
                            failedItems.push(item.name);
                        }
                        // Small delay to avoid rate limiting
                        await new Promise(r => setTimeout(r, 100));
                    }
                }
                
                console.log(`‚úÖ Migration complete: ${migratedItems.length} items migrated, ${failedItems.length} failed`);
                this.showStatus(`‚úì Migrated ${migratedItems.length} items`, 'success');
                
                return { 
                    migrated: migratedItems.length, 
                    failed: failedItems.length,
                    migratedItems: migratedItems,
                    failedItems: failedItems
                };
            }
        };
        
        // Auto-save with debounce
        let autoSaveTimeout = null;
        function autoSaveToCloud(key, value) {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                CloudStorage.save(key, value);
            }, 2000); // Save 2 seconds after last change
        }
        
        // Logout function (called from Settings page)
        function handleLogoutClick() {
            if (confirm('Are you sure you want to logout?')) {
                db.auth.signOut().then(() => {
                    console.log('‚úÖ Logged out successfully');
                    window.location.href = '/login.html';
                }).catch(error => {
                    console.error('Logout error:', error);
                    alert('Logout failed. Please try again.');
                });
            }
        }
        
        // Change password function
        async function handleChangePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const messageEl = document.getElementById('password-change-message');
            
            // Reset message
            messageEl.style.display = 'none';
            
            // Validation
            if (!newPassword || !confirmPassword) {
                showPasswordMessage('Please fill in both password fields', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showPasswordMessage('Password must be at least 6 characters long', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showPasswordMessage('Passwords do not match', 'error');
                return;
            }
            
            try {
                // Update password
                const { error } = await db.auth.updateUser({
                    password: newPassword
                });
                
                if (error) throw error;
                
                // Success!
                showPasswordMessage('‚úÖ Password updated successfully!', 'success');
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
                console.log('‚úÖ Password changed successfully');
                
            } catch (error) {
                console.error('Password change error:', error);
                showPasswordMessage('‚ùå Failed to update password: ' + error.message, 'error');
            }
        }
        
        function showPasswordMessage(message, type) {
            const messageEl = document.getElementById('password-change-message');
            messageEl.textContent = message;
            messageEl.style.display = 'block';
            
            if (type === 'success') {
                messageEl.style.background = 'rgba(0, 255, 163, 0.1)';
                messageEl.style.border = '1px solid rgba(0, 255, 163, 0.3)';
                messageEl.style.color = '#00FFA3';
            } else {
                messageEl.style.background = 'rgba(255, 71, 87, 0.1)';
                messageEl.style.border = '1px solid rgba(255, 71, 87, 0.3)';
                messageEl.style.color = '#FF6B6B';
            }
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 5000);
            }
        }
        
        // ========================================
        // CLOUD MIGRATION HANDLER
        // ========================================
        
        async function handleMigrateToCloud() {
            const btn = document.getElementById('migrate-btn');
            const resultEl = document.getElementById('migration-result');
            const statusText = document.getElementById('cloud-status-text');
            const statusDetails = document.getElementById('cloud-status-details');
            
            // Disable button
            btn.disabled = true;
            btn.textContent = '‚òÅÔ∏è Migrating...';
            
            resultEl.style.display = 'none';
            
            try {
                // Run migration
                const result = await CloudStorage.migrateToCloud();
                
                // Show result
                resultEl.style.display = 'block';
                resultEl.style.background = 'rgba(0, 255, 163, 0.1)';
                resultEl.style.border = '1px solid rgba(0, 255, 163, 0.3)';
                resultEl.style.color = '#00FFA3';
                
                let itemsList = '';
                if (result.migratedItems && result.migratedItems.length > 0) {
                    itemsList = '<div style="margin-top: 0.5rem; font-size: 0.85rem;">Migrated items:<br>' + 
                                result.migratedItems.map(item => '‚úì ' + item).join('<br>') + '</div>';
                }
                
                resultEl.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">‚úÖ Migration Complete!</div>
                    <div style="font-size: 0.9rem;">
                        ‚Ä¢ ${result.migrated} items migrated to cloud<br>
                        ${result.failed > 0 ? `‚Ä¢ ${result.failed} items failed<br>` : ''}
                        ‚Ä¢ Your data is now synced across all devices!
                    </div>
                    ${itemsList}
                `;
                
                // Update status
                statusText.textContent = '‚òÅÔ∏è Cloud Storage Active';
                statusText.style.color = 'var(--accent-green)';
                statusDetails.textContent = 'Data is synced to cloud. Accessible from any device.';
                
                // Hide migrate button
                btn.style.display = 'none';
                
                console.log('‚úÖ Migration successful');
                
            } catch (error) {
                console.error('‚ùå Migration failed:', error);
                
                resultEl.style.display = 'block';
                resultEl.style.background = 'rgba(255, 71, 87, 0.1)';
                resultEl.style.border = '1px solid rgba(255, 71, 87, 0.3)';
                resultEl.style.color = '#FF6B6B';
                resultEl.textContent = '‚ùå Migration failed: ' + error.message;
                
                btn.disabled = false;
                btn.textContent = '‚òÅÔ∏è Migrate to Cloud Storage';
            }
        }
        
        // ========================================
        // CLOUD DATABASE FUNCTIONS
        // ========================================
        
        console.log('üì¶ Loading FinanceIQ Cloud Database Module...');
        
        /**
         * OLD FUNCTIONS - DISABLED
         * These used finance_data table which caused 406 errors
         * Now using CloudStorage with user_settings table instead
         */
        
        /*
        async function saveFinanceDataToCloud(year, data) {
            // DISABLED - Use CloudStorage.save() instead
        }
        
        async function loadFinanceDataFromCloud(year) {
            try {
                const { data: { user } } = await db.auth.getUser();
                if (!user) throw new Error('Not authenticated');

                console.log('üì• Loading finance data for year:', year);

                // RLS automatically filters by user_id, don't add .eq('user_id')
                const { data, error } = await db
                    .from('finance_data')
                    .select('*')
                    .eq('year', year)
                    .single();

                if (error) {
                    if (error.code === 'PGRST116') {
                        console.log('‚ÑπÔ∏è No cloud data for year:', year);
                        return { success: true, data: null };
                    }
                    throw error;
                }

                console.log('‚úÖ Finance data loaded from cloud');
                return { success: true, data: data.data };

            } catch (error) {
                console.error('‚ùå Error loading finance data:', error);
                return { success: false, error: error.message };
            }
        }
        */
        
        /**
         * Check if cloud data exists for a year
         * DISABLED - Using CloudStorage.load instead
         */
        async function hasCloudData(year) {
            // OLD: const result = await loadFinanceDataFromCloud(year);
            // NEW: Just check user_settings table
            const data = await CloudStorage.loadFromCloud('financeData');
            return data !== null;
        }
        
        /**
         * OLD Migrate function - DISABLED
         * Using CloudStorage.migrateToCloud() instead
         */
        /*
        async function migrateToCloud() {
            // DISABLED - Uses old saveFinanceDataToCloud
            // Now using CloudStorage.migrateToCloud() in handleMigrateToCloud()
        }
        */
        
        /**
         * Auto-save to cloud with debounce
         */
        let cloudSaveTimeout = null;
        let isSaving = false;
        
        // OLD FUNCTION - DISABLED - Using CloudStorage.save() instead
        /*
        async function autoSaveToCloud(year, data, delay = 2000) {
            if (cloudSaveTimeout) {
                clearTimeout(cloudSaveTimeout);
            }
            
            // Show saving indicator
            updateSaveIndicator('saving');
            
            cloudSaveTimeout = setTimeout(async () => {
                if (isSaving) return;
                
                isSaving = true;
                console.log('üíæ Auto-saving to cloud...');
                
                const result = await saveFinanceDataToCloud(year, data);
                
                if (result.success) {
                    updateSaveIndicator('saved');
                } else {
                    updateSaveIndicator('error');
                }
                
                isSaving = false;
            }, delay);
        }
        */
        
        /**
         * Update save indicator in UI
         */
        function updateSaveIndicator(status) {
            // We'll add a save indicator to the header later
            const indicator = document.getElementById('save-indicator');
            if (!indicator) return;
            
            switch(status) {
                case 'saving':
                    indicator.textContent = 'üíæ Saving...';
                    indicator.style.color = 'var(--accent-blue)';
                    indicator.style.display = 'inline';
                    break;
                case 'saved':
                    indicator.textContent = '‚úì Saved';
                    indicator.style.color = 'var(--accent-green)';
                    indicator.style.display = 'inline';
                    setTimeout(() => {
                        indicator.style.display = 'none';
                    }, 2000);
                    break;
                case 'error':
                    indicator.textContent = '‚ö† Save failed';
                    indicator.style.color = 'var(--accent-red)';
                    indicator.style.display = 'inline';
                    setTimeout(() => {
                        indicator.style.display = 'none';
                    }, 3000);
                    break;
            }
        }
        
        console.log('‚úÖ Cloud Database Module Ready!');
        
        // ========================================
        // MIGRATION HANDLER
        // ========================================
        
        async function handleMigrateToCloud() {
            const btn = document.getElementById('migrate-btn');
            const resultEl = document.getElementById('migration-result');
            const statusEl = document.getElementById('cloud-status-text');
            const detailsEl = document.getElementById('cloud-status-details');
            
            // Disable button
            btn.disabled = true;
            btn.textContent = '‚òÅÔ∏è Migrating... Please wait';
            
            // Hide previous result
            resultEl.style.display = 'none';
            
            try {
                // Run migration
                const result = await migrateToCloud();
                
                if (result.success) {
                    // Success!
                    resultEl.style.display = 'block';
                    resultEl.style.background = 'rgba(0, 255, 163, 0.1)';
                    resultEl.style.border = '1px solid rgba(0, 255, 163, 0.3)';
                    resultEl.style.color = 'var(--accent-green)';
                    resultEl.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">‚úÖ Migration Successful!</div>
                        <div style="font-size: 0.9rem;">Your data has been migrated to the cloud. You can now access it from any device!</div>
                    `;
                    
                    // Update status
                    statusEl.textContent = '‚òÅÔ∏è Cloud Storage Active';
                    statusEl.style.color = 'var(--accent-green)';
                    detailsEl.textContent = 'Data synced to cloud. Accessible from any device.';
                    
                    // Change button
                    btn.textContent = '‚úì Migrated to Cloud';
                    btn.style.background = 'var(--accent-green)';
                    
                } else {
                    // Error
                    resultEl.style.display = 'block';
                    resultEl.style.background = 'rgba(255, 71, 87, 0.1)';
                    resultEl.style.border = '1px solid rgba(255, 71, 87, 0.3)';
                    resultEl.style.color = 'var(--accent-red)';
                    resultEl.textContent = '‚ùå Migration Failed: ' + result.message;
                    
                    // Re-enable button
                    btn.disabled = false;
                    btn.textContent = '‚òÅÔ∏è Migrate to Cloud Storage';
                }
                
            } catch (error) {
                console.error('Migration error:', error);
                resultEl.style.display = 'block';
                resultEl.style.background = 'rgba(255, 71, 87, 0.1)';
                resultEl.style.border = '1px solid rgba(255, 71, 87, 0.3)';
                resultEl.style.color = 'var(--accent-red)';
                resultEl.textContent = '‚ùå Migration Failed: ' + error.message;
                
                // Re-enable button
                btn.disabled = false;
                btn.textContent = '‚òÅÔ∏è Migrate to Cloud Storage';
            }
        }
        
        // Check cloud status on Settings page load
        async function checkCloudStatus() {
            const currentYear = new Date().getFullYear();
            const hasData = await hasCloudData(currentYear);
            
            if (hasData) {
                const statusEl = document.getElementById('cloud-status-text');
                const detailsEl = document.getElementById('cloud-status-details');
                const btn = document.getElementById('migrate-btn');
                
                if (statusEl) {
                    statusEl.textContent = '‚òÅÔ∏è Cloud Storage Active';
                    statusEl.style.color = 'var(--accent-green)';
                }
                if (detailsEl) {
                    detailsEl.textContent = 'Data synced to cloud. Accessible from any device.';
                }
                if (btn) {
                    btn.textContent = '‚úì Using Cloud Storage';
                    btn.disabled = true;
                    btn.style.background = 'var(--accent-green)';
                }
            }
        }
    </script>
</head>
<body>
    <div class="app">
        <aside class="sidebar">
            <div class="logo">üí∞ FinanceIQ</div>
            <nav>
                <div class="nav-item active" onclick="showPage('dashboard')">
                    <span>üìä</span>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" onclick="showPage('monthly')">
                    <span>üìÖ</span>
                    <span>Monthly View</span>
                </div>
                <div class="nav-item" onclick="showPage('expenses')">
                    <span>üí∏</span>
                    <span>Expenses</span>
                </div>
                <div class="nav-item" onclick="showPage('income')">
                    <span>üí∞</span>
                    <span>Income</span>
                </div>
                <div class="nav-item" onclick="showPage('debt')">
                    <span>‚ö†Ô∏è</span>
                    <span>Debt Tracker</span>
                </div>
                <div class="nav-item" onclick="showPage('budget')">
                    <span>üéØ</span>
                    <span>Budget</span>
                </div>
                <div class="nav-item" onclick="showPage('goals')">
                    <span>üéñÔ∏è</span>
                    <span>Goals</span>
                </div>
                <div class="nav-item" onclick="showPage('insights')">
                    <span>ü§ñ</span>
                    <span>AI Insights</span>
                </div>
                <div class="nav-item" onclick="showPage('reports')">
                    <span>üìë</span>
                    <span>Reports</span>
                </div>
                <div class="nav-item" onclick="showPage('settings')">
                    <span>‚öôÔ∏è</span>
                    <span>Settings</span>
                </div>
            </nav>
        </aside>

        <main class="main">
            <!-- Top Header Bar -->
            <div class="top-header">
                <div class="top-header-left">
                    <div class="top-header-title" id="page-title">Financial Dashboard</div>
                </div>
                <div class="top-header-right">
                    <div class="user-badge">
                        <span>üë§</span>
                        <span id="header-user-email">Loading...</span>
                    </div>
                    <div id="save-indicator" style="display: none; font-size: 0.85rem; margin-left: 1rem;"></div>
                </div>
            </div>

            <div class="main-content">
            <!-- Dashboard -->
            <div id="dashboard-page" class="page">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Financial Dashboard</h1>
                        <p class="page-subtitle">Complete overview</p>
                    </div>
                </div>
                <div class="card-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Income (2025)</div>
                        <div class="stat-value" id="totalIncome">¬£0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Expenses (2025)</div>
                        <div class="stat-value" id="totalExpenses">¬£0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Net Position</div>
                        <div class="stat-value" id="netPosition">¬£0</div>
                    </div>
                </div>
                
                <!-- Debt Overview Section -->
                <div id="dashboardDebtOverview"></div>
                
                <div class="chart-card">
                    <h3 class="chart-title">Monthly Cash Flow</h3>
                    <canvas id="cashFlowChart"></canvas>
                </div>
            </div>

            <!-- Monthly View -->
            <div id="monthly-page" class="page hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Monthly Bill Tracker</h1>
                        <p class="page-subtitle">Track what's paid and what's pending</p>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="openAddIncomeModal()">üì• Add Income</button>
                        <button class="btn btn-secondary" onclick="openAddExpenseModal()">üí∏ Add Expense</button>
                    </div>
                </div>

                <div class="year-selector">
                    <button class="year-btn" onclick="selectYear(2024)">2024</button>
                    <button class="year-btn active" onclick="selectYear(2025)">2025</button>
                    <button class="year-btn" onclick="selectYear(2026)">2026</button>
                </div>

                <div class="month-selector">
                    <button class="month-btn" data-month="0" onclick="selectMonth(0)">Jan</button>
                    <button class="month-btn" data-month="1" onclick="selectMonth(1)">Feb</button>
                    <button class="month-btn" data-month="2" onclick="selectMonth(2)">Mar</button>
                    <button class="month-btn" data-month="3" onclick="selectMonth(3)">Apr</button>
                    <button class="month-btn" data-month="4" onclick="selectMonth(4)">May</button>
                    <button class="month-btn" data-month="5" onclick="selectMonth(5)">Jun</button>
                    <button class="month-btn" data-month="6" onclick="selectMonth(6)">Jul</button>
                    <button class="month-btn" data-month="7" onclick="selectMonth(7)">Aug</button>
                    <button class="month-btn" data-month="8" onclick="selectMonth(8)">Sep</button>
                    <button class="month-btn" data-month="9" onclick="selectMonth(9)">Oct</button>
                    <button class="month-btn" data-month="10" onclick="selectMonth(10)">Nov</button>
                    <button class="month-btn" data-month="11" onclick="selectMonth(11)">Dec</button>
                </div>

                <div id="monthlyContent"></div>
            </div>

            <!-- Expenses -->
            <div id="expenses-page" class="page hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Expense Management</h1>
                        <p class="page-subtitle">Manage recurring and one-off expenses</p>
                    </div>
                </div>
                <div id="expensesContent"></div>
            </div>

            <!-- Income -->
            <div id="income-page" class="page hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Income Management</h1>
                        <p class="page-subtitle">Track income sources</p>
                    </div>
                </div>
                <div id="incomeContent"></div>
            </div>

            <!-- Debt Tracker -->
            <div id="debt-page" class="page hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Debt Management</h1>
                        <p class="page-subtitle">Track and eliminate debt strategically</p>
                    </div>
                    <button class="btn btn-primary" onclick="openAddDebtModal()">‚ûï Add Debt</button>
                </div>
                <div id="debtContent"></div>
            </div>

            <!-- AI Insights -->
            <div id="insights-page" class="page hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">AI Financial Insights</h1>
                        <p class="page-subtitle">Powered by OpenAI GPT-4o</p>
                    </div>
                </div>
                <div id="insightsContent"></div>
            </div>

            <!-- Budget Planning -->
            <div id="budget-page" class="page hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Budget Planning</h1>
                        <p class="page-subtitle">Set monthly limits and track spending</p>
                    </div>
                </div>
                <div id="budgetContent"></div>
            </div>

            <!-- Financial Goals -->
            <div id="goals-page" class="page hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Financial Goals</h1>
                        <p class="page-subtitle">Track your progress towards financial milestones</p>
                    </div>
                    <button class="btn btn-primary" onclick="openAddGoalModal()">‚ûï Add Goal</button>
                </div>
                <div id="goalsContent"></div>
            </div>

            <!-- Reports & Export -->
            <div id="reports-page" class="page hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Reports & Export</h1>
                        <p class="page-subtitle">Generate financial reports and export data</p>
                    </div>
                </div>
                <div id="reportsContent"></div>
            </div>

            <!-- Settings -->
            <div id="settings-page" class="page hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Settings</h1>
                        <p class="page-subtitle">Sync and configuration</p>
                    </div>
                </div>

                <div class="chart-card">
                    <h3 class="chart-title">üë§ Personal Profile (for AI)</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                        Tell the AI about yourself so it can give personalized advice based on YOUR situation.
                    </p>
                    <div class="form-group">
                        <label>Current Job/Career</label>
                        <input type="text" id="profileJob" placeholder="e.g., Prison Manager, Security Operations Manager" />
                    </div>
                    <div class="form-group">
                        <label>Annual Salary</label>
                        <input type="number" id="profileSalary" placeholder="e.g., 43000" />
                    </div>
                    <div class="form-group">
                        <label>Career Goals/Plans</label>
                        <textarea id="profileCareerGoals" rows="3" placeholder="e.g., Transitioning from prison management to corporate operations management. Looking for leadership roles in logistics, security services, or business operations."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Side Business/Self-Employment</label>
                        <textarea id="profileSideBusiness" rows="3" placeholder="e.g., Run LogicLoopDigital - automation specialist and app builder for small businesses. Early stage, building client base."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="profileLocation" placeholder="e.g., Peterborough, UK" />
                    </div>
                    <div class="form-group">
                        <label>Additional Context (Family, Goals, etc.)</label>
                        <textarea id="profileContext" rows="3" placeholder="e.g., Partner works for NHS. Own property in Portugal. Fluent in Portuguese. Goal to reduce debt and potentially relocate."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="savePersonalProfile()">Save Profile</button>
                    <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-secondary);">
                        ‚ÑπÔ∏è This information is stored locally and only sent to AI when you request insights.
                    </p>
                </div>

                <div class="chart-card">
                    <h3 class="chart-title">OpenAI API Configuration</h3>
                    <div class="form-group">
                        <label>OpenAI API Key</label>
                        <input type="password" id="openaiKeyInput" placeholder="sk-proj-..." />
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                            Required for AI debt strategy and predictions. Get from 
                            <a href="https://platform.openai.com/api-keys" target="_blank" style="color: var(--accent-green);">OpenAI Platform</a>
                        </p>
                    </div>
                    <button class="btn btn-primary" onclick="saveOpenAIKey()">Save API Key</button>
                </div>

                <div class="chart-card">
                    <h3 class="chart-title">Google Drive Sync</h3>
                    <button class="btn btn-primary" id="authorizeButton" onclick="handleAuthClick()">
                        üîó Connect Google Drive
                    </button>
                    <button class="btn btn-secondary" id="signoutButton" onclick="handleSignoutClick()" style="display:none; margin-left: 1rem;">
                        Disconnect
                    </button>
                    <p class="mt-2" style="color: var(--text-secondary);">
                        Sync your data across all devices using Google Drive
                    </p>
                    <div id="syncStatus" class="mt-2"></div>
                </div>

                <div class="chart-card">
                    <h3 class="chart-title">Complete Data Backup & Transfer</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                        üí° <strong>Transfer data between app versions:</strong><br>
                        1. Download backup from old version<br>
                        2. Upload backup to new version<br>
                        3. All your data is restored!
                    </p>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                        <strong>Backup includes:</strong> All finances, goals, recurring expenses, budgets, personal profile, and settings.
                    </p>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="exportData()">
                            üì• Download Complete Backup
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                            üì§ Upload Backup (Restore Data)
                        </button>
                    </div>
                    <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
                    <p style="color: var(--accent-yellow); margin-top: 1rem; font-size: 0.9rem;">
                        ‚ö†Ô∏è Warning: Uploading a backup will replace ALL current data. Export current data first if you want to keep it!
                    </p>
                </div>

                <div class="chart-card" style="background: rgba(0, 255, 163, 0.05); border-color: rgba(0, 255, 163, 0.3);">
                    <h3 class="chart-title">‚òÅÔ∏è Cloud Storage</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                        Your data is currently stored locally in your browser. Migrate to cloud storage for multi-device access and automatic backup!
                    </p>
                    
                    <div id="cloud-status" style="padding: 1rem; background: rgba(0, 0, 0, 0.2); border-radius: 8px; margin-bottom: 1.5rem;">
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Status:</div>
                        <div id="cloud-status-text" style="font-size: 1.05rem; font-weight: 600; color: var(--accent-yellow);">üì¶ Local Storage Only</div>
                        <div id="cloud-status-details" style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                            Data is saved in your browser. Not synced across devices.
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="handleMigrateToCloud()" id="migrate-btn" style="max-width: 400px; margin-bottom: 1rem;">
                        ‚òÅÔ∏è Migrate to Cloud Storage
                    </button>
                    
                    <div id="migration-result" style="display: none; padding: 1rem; border-radius: 8px; margin-top: 1rem;"></div>
                    
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 1rem;">
                        ‚ÑπÔ∏è After migration, your data will be accessible from any device. Your local data will be kept as backup.
                    </p>
                </div>

                <div class="chart-card" style="background: rgba(255, 71, 87, 0.05); border-color: rgba(255, 71, 87, 0.3);">
                    <h3 class="chart-title">üîê Account Management</h3>
                    <div style="padding: 1rem; background: rgba(0, 255, 163, 0.05); border: 1px solid rgba(0, 255, 163, 0.2); border-radius: 8px; margin-bottom: 1.5rem;">
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Logged in as:</div>
                        <div id="current-user-email" style="font-size: 1.1rem; font-weight: 600; color: var(--accent-green);">Loading...</div>
                    </div>
                    <button class="btn" onclick="handleLogoutClick()" style="background: linear-gradient(135deg, #FF4757 0%, #FF6B6B 100%); width: 100%; max-width: 300px;">
                        üö™ Logout
                    </button>
                    <p style="color: var(--text-secondary); margin-top: 1rem; font-size: 0.85rem;">
                        ‚ÑπÔ∏è Your data is saved automatically. You can login from any device.
                    </p>
                    
                    <hr style="border: none; border-top: 1px solid var(--border); margin: 2rem 0;">
                    
                    <h4 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">Change Password</h4>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="newPassword" placeholder="Enter new password (min. 6 characters)" style="width: 100%; max-width: 400px;"/>
                    </div>
                    <div class="form-group">
                        <label>Confirm New Password</label>
                        <input type="password" id="confirmPassword" placeholder="Re-enter new password" style="width: 100%; max-width: 400px;"/>
                    </div>
                    <button class="btn btn-primary" onclick="handleChangePassword()" style="max-width: 300px;">
                        üîë Update Password
                    </button>
                    <div id="password-change-message" style="margin-top: 1rem; padding: 0.75rem; border-radius: 8px; display: none;"></div>
                </div>
            </div>
            </div>
        </main>
    </div>

    <!-- Add Income Modal -->
    <div id="addIncomeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Income</h3>
                <span class="close-btn" onclick="closeModal('addIncomeModal')">&times;</span>
            </div>
            <form onsubmit="addIncome(event)">
                <div class="form-group">
                    <label>Income Source</label>
                    <input type="text" id="incomeName" required placeholder="e.g., Salary, Bonus, Freelance" />
                </div>
                <div class="form-group">
                    <label>Amount (¬£)</label>
                    <input type="number" step="0.01" id="incomeAmount" required placeholder="0.00" />
                </div>
                <div class="form-group">
                    <label>Month</label>
                    <select id="incomeMonth" required>
                        <option value="0">January</option>
                        <option value="1">February</option>
                        <option value="2">March</option>
                        <option value="3">April</option>
                        <option value="4">May</option>
                        <option value="5">June</option>
                        <option value="6">July</option>
                        <option value="7">August</option>
                        <option value="8">September</option>
                        <option value="9">October</option>
                        <option value="10">November</option>
                        <option value="11">December</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Year</label>
                    <select id="incomeYear" required>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026" selected>2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Add Income</button>
            </form>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Expense</h3>
                <span class="close-btn" onclick="closeModal('addExpenseModal')">&times;</span>
            </div>
            <form onsubmit="addExpense(event)">
                <div class="form-group">
                    <label>Category</label>
                    <select id="expenseCategory" required>
                        <option value="HOME">Home</option>
                        <option value="UTILITIES">Utilities</option>
                        <option value="CAR/TRANSPORTS">Car/Transport</option>
                        <option value="EDUCATION">Education</option>
                        <option value="INSURANCES">Insurance</option>
                        <option value="HOBBIES/HOLIDAYS">Hobbies/Holidays</option>
                        <option value="OTHERS">Others</option>
                        <option value="MATERIAL">Shopping/Material</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Expense Name</label>
                    <input type="text" id="expenseName" required placeholder="e.g., Grocery Shopping, Petrol" />
                </div>
                <div class="form-group">
                    <label>Amount (¬£)</label>
                    <input type="number" step="0.01" id="expenseAmount" required placeholder="0.00" />
                </div>
                <div class="form-group">
                    <label>Month</label>
                    <select id="expenseMonth" required>
                        <option value="0">January</option>
                        <option value="1">February</option>
                        <option value="2">March</option>
                        <option value="3">April</option>
                        <option value="4">May</option>
                        <option value="5">June</option>
                        <option value="6">July</option>
                        <option value="7">August</option>
                        <option value="8">September</option>
                        <option value="9">October</option>
                        <option value="10">November</option>
                        <option value="11">December</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Year</label>
                    <select id="expenseYear" required>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026" selected>2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="paymentType" value="cash" checked onchange="updatePaymentOptions()">
                            <span>üíµ Cash / Debit Card</span>
                        </label>
                        
                        <div>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="paymentType" value="creditCard" onchange="updatePaymentOptions()">
                                <span>üí≥ Credit Card (adds to debt)</span>
                            </label>
                            <div id="creditCardSection" style="margin-left: 1.5rem; margin-top: 0.5rem; display: none;">
                                <select id="creditCardDebt" class="form-control" style="width: 100%;">
                                    <option value="">Select credit card...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="paymentType" value="debtPayment" onchange="updatePaymentOptions()">
                                <span>üí∞ Debt Payment (reduces debt)</span>
                            </label>
                            <div id="debtPaymentSection" style="margin-left: 1.5rem; margin-top: 0.5rem; display: none;">
                                <select id="debtPaymentTarget" class="form-control" style="width: 100%;">
                                    <option value="">Select debt to pay...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="expenseRecurring" style="width: auto;">
                        <span>This is a recurring expense (will auto-populate future months)</span>
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">Add Expense</button>
            </form>
        </div>
    </div>

    <!-- Add Debt Modal -->
    <div id="addDebtModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Debt</h3>
                <span class="close-btn" onclick="closeModal('addDebtModal')">&times;</span>
            </div>
            <form onsubmit="addDebt(event)">
                <div class="form-group">
                    <label>Debt Name</label>
                    <input type="text" id="debtName" required placeholder="e.g., Credit Card, Car Loan, Mortgage" />
                </div>
                <div class="form-group">
                    <label>Amount Owed (¬£)</label>
                    <input type="number" step="0.01" id="debtAmount" required placeholder="0.00" />
                </div>
                <div class="form-group">
                    <label>Interest Rate (%)</label>
                    <input type="text" id="debtInterestRate" required placeholder="e.g., 18.9, 21.5, 8-12" />
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        Enter exact rate (e.g., "18.9") or range (e.g., "18-25")
                    </p>
                </div>
                <div class="form-group">
                    <label>Year</label>
                    <select id="debtYear" required>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026" selected>2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Add Debt</button>
            </form>
        </div>
    </div>

    <!-- Edit Debt Modal -->
    <div id="editDebtModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Debt</h3>
                <span class="close-btn" onclick="closeModal('editDebtModal')">&times;</span>
            </div>
            <form onsubmit="updateDebt(event)">
                <input type="hidden" id="editDebtIndex" />
                <div class="form-group">
                    <label>Debt Name</label>
                    <input type="text" id="editDebtName" required placeholder="e.g., Credit Card, Car Loan" />
                </div>
                <div class="form-group">
                    <label>Amount Owed (¬£)</label>
                    <input type="number" step="0.01" id="editDebtAmount" required placeholder="0.00" />
                </div>
                <div class="form-group">
                    <label>Interest Rate (%)</label>
                    <input type="text" id="editDebtInterestRate" required placeholder="e.g., 18.9, 21.5, 8-12" />
                </div>
                <button type="submit" class="btn btn-primary">Update Debt</button>
            </form>
        </div>
    </div>

    <!-- Add Recurring Expense Modal -->
    <div id="addRecurringModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Recurring Expense</h3>
                <span class="close-btn" onclick="closeModal('addRecurringModal')">&times;</span>
            </div>
            <form onsubmit="addRecurringExpense(event)">
                <div class="form-group">
                    <label>Category</label>
                    <select id="recurringCategory" required>
                        <option value="HOME">üè† Home</option>
                        <option value="UTILITIES">‚ö° Utilities</option>
                        <option value="CAR/TRANSPORTS">üöó Car/Transport</option>
                        <option value="EDUCATION">üìö Education</option>
                        <option value="INSURANCES">üõ°Ô∏è Insurance</option>
                        <option value="HOBBIES/HOLIDAYS">üéÆ Hobbies/Holidays</option>
                        <option value="OTHERS">üì¶ Others</option>
                        <option value="MATERIAL">üõí Material</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Bill Name</label>
                    <input type="text" id="recurringName" required placeholder="e.g., Rent, Electric, Netflix" />
                </div>
                <div class="form-group">
                    <label>Typical Monthly Amount (¬£)</label>
                    <input type="number" step="0.01" id="recurringAmount" required placeholder="0.00" />
                </div>
                <div class="form-group">
                    <label>Due Day of Month (Optional)</label>
                    <input type="number" id="recurringDueDay" min="1" max="31" placeholder="e.g., 15" />
                    <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">
                        When is this bill typically due each month?
                    </small>
                </div>
                <button type="submit" class="btn btn-primary">Add Recurring Expense</button>
            </form>
        </div>
    </div>

    <!-- Edit Recurring Expense Modal -->
    <div id="editRecurringModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Recurring Expense</h3>
                <span class="close-btn" onclick="closeModal('editRecurringModal')">&times;</span>
            </div>
            <form onsubmit="updateRecurringExpense(event)">
                <input type="hidden" id="editRecurringIndex" />
                <div class="form-group">
                    <label>Category</label>
                    <select id="editRecurringCategory" required>
                        <option value="HOME">üè† Home</option>
                        <option value="UTILITIES">‚ö° Utilities</option>
                        <option value="CAR/TRANSPORTS">üöó Car/Transport</option>
                        <option value="EDUCATION">üìö Education</option>
                        <option value="INSURANCES">üõ°Ô∏è Insurance</option>
                        <option value="HOBBIES/HOLIDAYS">üéÆ Hobbies/Holidays</option>
                        <option value="OTHERS">üì¶ Others</option>
                        <option value="MATERIAL">üõí Material</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Bill Name</label>
                    <input type="text" id="editRecurringName" required placeholder="e.g., Rent, Electric, Netflix" />
                </div>
                <div class="form-group">
                    <label>Typical Monthly Amount (¬£)</label>
                    <input type="number" step="0.01" id="editRecurringAmount" required placeholder="0.00" />
                </div>
                <div class="form-group">
                    <label>Due Day of Month (Optional)</label>
                    <input type="number" id="editRecurringDueDay" min="1" max="31" placeholder="e.g., 15" />
                    <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">
                        When is this bill typically due each month?
                    </small>
                </div>
                <button type="submit" class="btn btn-primary">Update Recurring Expense</button>
            </form>
        </div>
    </div>

    <!-- Add Goal Modal -->
    <div id="addGoalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Financial Goal</h3>
                <span class="close-btn" onclick="closeModal('addGoalModal')">&times;</span>
            </div>
            <form onsubmit="addGoal(event)">
                <div class="form-group">
                    <label>Goal Type</label>
                    <select id="goalType" required>
                        <option value="Emergency Fund">üõ°Ô∏è Emergency Fund</option>
                        <option value="House Deposit">üè† House Deposit</option>
                        <option value="Car">üöó Car Purchase</option>
                        <option value="Holiday">‚úàÔ∏è Holiday/Vacation</option>
                        <option value="Debt Payoff">üí≥ Debt Payoff</option>
                        <option value="Wedding">üíç Wedding</option>
                        <option value="Education">üìö Education</option>
                        <option value="Custom">‚ú® Custom Goal</option>
                    </select>
                </div>
                <div class="form-group" id="customGoalName" style="display: none;">
                    <label>Custom Goal Name</label>
                    <input type="text" id="goalCustomName" placeholder="e.g., New Business, Relocation Fund" />
                </div>
                <div class="form-group">
                    <label>Target Amount (¬£)</label>
                    <input type="number" step="0.01" id="goalTargetAmount" required placeholder="10000.00" />
                </div>
                <div class="form-group">
                    <label>Current Saved Amount (¬£)</label>
                    <input type="number" step="0.01" id="goalCurrentAmount" required placeholder="0.00" value="0" />
                </div>
                <div class="form-group">
                    <label>Target Date</label>
                    <input type="date" id="goalTargetDate" required />
                </div>
                <div class="form-group">
                    <label>Description (Optional)</label>
                    <textarea id="goalDescription" rows="2" placeholder="e.g., 6 months of living expenses for security"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Create Goal</button>
            </form>
        </div>
    </div>

    <!-- Edit Goal Modal -->
    <div id="editGoalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Update Goal Progress</h3>
                <span class="close-btn" onclick="closeModal('editGoalModal')">&times;</span>
            </div>
            <form onsubmit="updateGoalProgress(event)">
                <input type="hidden" id="editGoalIndex" />
                <div class="form-group">
                    <label>Current Saved Amount (¬£)</label>
                    <input type="number" step="0.01" id="editGoalAmount" required placeholder="0.00" />
                </div>
                <button type="submit" class="btn btn-primary">Update Progress</button>
            </form>
        </div>
    </div>

    <script>
        // Google Drive API Configuration
        const CLIENT_ID = '815791700552-ci735hlnrugp8e14mp71plomgrc2an8u.apps.googleusercontent.com'; // User will replace this
        const API_KEY = 'AIzaSyAjOb7XCNPTAIsOHQJB7zHcdxb7YEHog4I'; // User will replace this
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let driveFileId = null;

        // Initialize data
        let FINANCE_DATA = 
{
  "2024": {
    "expenses": {
      "HOME": [
        {
          "name": "HOUSE RENT",
          "monthly": [
            995.0,
            995.0,
            995.0,
            995.0,
            995.0,
            995.0,
            995.0,
            995.0,
            995.0,
            995.0,
            995.0,
            995.0
          ],
          "total": 11940.0
        },
        {
          "name": "COUNCIL TAX",
          "monthly": [
            133.0,
            0.0,
            0.0,
            140.68,
            142.0,
            142.0,
            142.0,
            142.0,
            142.46,
            142.0,
            142.0,
            142.0
          ],
          "total": 1410.14
        }
      ],
      "UTILITIES": [
        {
          "name": "Electricity/GAS",
          "monthly": [
            318.62,
            318.62,
            318.62,
            318.62,
            318.62,
            318.62,
            247.83,
            247.18,
            247.18,
            247.18,
            212.81,
            212.81
          ],
          "total": 3326.71
        },
        {
          "name": "WATER",
          "monthly": [
            51.0,
            51.0,
            51.0,
            60.0,
            60.0,
            60.0,
            60.0,
            60.0,
            60.0,
            60.0,
            60.0,
            60.0
          ],
          "total": 693.0
        },
        {
          "name": "INTERNET",
          "monthly": [
            37.0,
            37.0,
            37.0,
            37.0,
            37.0,
            40.25,
            40.25,
            40.25,
            40.25,
            40.25,
            40.25,
            50.14
          ],
          "total": 476.64
        }
      ],
      "CAR/TRANSPORTS": [
        {
          "name": "CAR CREDIT",
          "monthly": [
            300.61,
            300.61,
            300.61,
            300.61,
            300.61,
            300.61,
            300.61,
            300.61,
            300.61,
            300.61,
            300.61,
            300.61
          ],
          "total": 3607.32
        },
        {
          "name": "FUEL",
          "monthly": [
            180.0,
            88.59,
            233.0,
            147.43,
            200.0,
            200.0,
            200.0,
            200.0,
            200.0,
            100.0,
            100.0,
            60.0
          ],
          "total": 1909.02
        },
        {
          "name": "MAINTENANCE",
          "monthly": [
            167.02,
            167.02,
            0.0,
            0.0,
            0.0,
            0.0,
            650.0,
            292.29,
            292.29,
            292.29,
            292.29,
            292.29
          ],
          "total": 2445.4900000000002
        }
      ],
      "MOT": [
        {
          "name": "PARKING",
          "monthly": [
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            60.0,
            0.0
          ],
          "total": 60.0
        }
      ],
      "OTHERS": [
        {
          "name": "Andre Alowance",
          "monthly": [
            50.0,
            50.0,
            50.0,
            50.0,
            50.0,
            50.0,
            60.0,
            60.0,
            60.0,
            60.0,
            60.0,
            60.0
          ],
          "total": 660.0
        },
        {
          "name": "Lourenco Alowance",
          "monthly": [
            10.0,
            15.0,
            10.0,
            10.0,
            10.0,
            15.0,
            20.0,
            15.0,
            20.0,
            0.0,
            10.0,
            10.0
          ],
          "total": 145.0
        },
        {
          "name": "Mobile Ricardo",
          "monthly": [
            11.71,
            11.71,
            11.71,
            11.71,
            12.73,
            17.68,
            11.71,
            12.73,
            12.73,
            12.73,
            12.73,
            12.73
          ],
          "total": 152.61
        },
        {
          "name": "Mobile Lou",
          "monthly": [
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            10.0,
            10.0
          ],
          "total": 70.0
        },
        {
          "name": "Mobile Andre",
          "monthly": [
            11.71,
            11.71,
            11.71,
            11.71,
            11.71,
            11.71,
            11.71,
            11.71,
            12.73,
            12.73,
            12.73,
            10.0
          ],
          "total": 141.87
        },
        {
          "name": "Andre Training",
          "monthly": [
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            60.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 60.0
        },
        {
          "name": "POA",
          "monthly": [
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            16.0,
            16.0,
            16.0,
            16.0,
            16.0
          ],
          "total": 80.0
        },
        {
          "name": "Gifts",
          "monthly": [
            28.0,
            0.0,
            0.0,
            50.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 78.0
        }
      ],
      "EDUCATION": [
        {
          "name": "ANDRE BUS PASS",
          "monthly": [
            0.0,
            38.0,
            38.0,
            38.0,
            38.0,
            38.0,
            38.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 228.0
        },
        {
          "name": "Lou Course",
          "monthly": [
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            279.0,
            0.0,
            99.0,
            99.0,
            99.0,
            99.0
          ],
          "total": 675.0
        }
      ],
      "MATERIAL": [
        {
          "name": "Overdraft Halifax",
          "monthly": [
            55.0,
            60.0,
            60.0,
            60.0,
            60.0,
            60.0,
            60.0,
            60.0,
            60.0,
            60.0,
            0.0,
            0.0
          ],
          "total": 595.0
        },
        {
          "name": "Halifax repayment",
          "monthly": [
            0.0,
            0.0,
            800.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 800.0
        },
        {
          "name": "capital one card",
          "monthly": [
            149.49,
            151.52,
            149.69,
            141.38,
            141.43,
            135.4,
            200.0,
            138.86,
            148.67,
            141.12,
            141.12,
            148.03
          ],
          "total": 1786.71
        },
        {
          "name": "Marbles card",
          "monthly": [
            242.95,
            256.73,
            243.69,
            238.33,
            285.85,
            285.0,
            256.73,
            237.58,
            296.53,
            255.8,
            255.8,
            260.58
          ],
          "total": 3115.57
        },
        {
          "name": "Argos Card",
          "monthly": [
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            50.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 50.0
        },
        {
          "name": "Nest",
          "monthly": [
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            6.0,
            6.0,
            6.0
          ],
          "total": 63.0
        },
        {
          "name": "EZVIZ",
          "monthly": [
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            5.0
          ],
          "total": 60.0
        }
      ],
      "HOLIDAYS": [
        {
          "name": "Investments",
          "monthly": [
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            50.0,
            50.0,
            50.0,
            50.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 200.0
        },
        {
          "name": "Sofa credit",
          "monthly": [
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            88.08,
            88.08,
            88.08,
            0.0
          ],
          "total": 264.24
        }
      ],
      "SAVINGS": [
        {
          "name": "TOTTAL BANKS",
          "monthly": [
            457.44,
            478.25,
            1263.38,
            449.71,
            497.28,
            540.4,
            576.73,
            496.44,
            703.28,
            556.0,
            496.0,
            419.61
          ],
          "total": 6934.52
        }
      ],
      "HOBBIES/HOLIDAYS": [
        {
          "name": "Subscriptions",
          "monthly": [
            0.0,
            0.0,
            0.0,
            39.99,
            15.0,
            0.0,
            0.0,
            0.0,
            0.0,
            19.76,
            0.0,
            0.0
          ],
          "total": 74.75
        },
        {
          "name": "Holydays/Parkdean resorts",
          "monthly": [
            76.0,
            76.0,
            76.0,
            76.0,
            76.0,
            76.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 456.0
        }
      ],
      "INSURENCES": [
        {
          "name": "Life insurence",
          "monthly": [
            20.62,
            20.62,
            20.62,
            20.62,
            20.62,
            20.62,
            20.62,
            20.62,
            20.62,
            20.62,
            20.62,
            20.62
          ],
          "total": 247.44
        },
        {
          "name": "Car insurance",
          "monthly": [
            85.11,
            85.11,
            85.11,
            85.11,
            85.11,
            85.11,
            0.0,
            83.1,
            83.1,
            83.1,
            83.1,
            79.25
          ],
          "total": 922.31
        },
        {
          "name": "Dental insurance",
          "monthly": [
            10.0,
            10.0,
            10.0,
            10.0,
            10.0,
            10.0,
            10.0,
            10.0,
            10.0,
            10.0,
            10.0,
            10.0
          ],
          "total": 120.0
        }
      ]
    },
    "income": {
      "items": [
        {
          "name": "Salary",
          "monthly": [
            2700.0,
            2533.0,
            3715.12,
            2924.32,
            2889.37,
            3185.02,
            2950.0,
            2613.94,
            3172.45,
            2713.0,
            2716.44,
            2733.0
          ],
          "total": 34845.66
        },
        {
          "name": "Ana Car",
          "monthly": [
            175.0,
            175.0,
            175.0,
            175.0,
            175.0,
            175.0,
            175.0,
            175.0,
            175.0,
            175.0,
            175.0,
            175.0
          ],
          "total": 2100.0
        },
        {
          "name": "Ana Electricity",
          "monthly": [
            0.0,
            65.0,
            65.0,
            65.0,
            65.0,
            65.0,
            44.0,
            44.0,
            60.0,
            60.0,
            60.0,
            0.0
          ],
          "total": 593.0
        },
        {
          "name": "Ana Holiday",
          "monthly": [
            0.0,
            38.0,
            38.0,
            38.0,
            38.0,
            38.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 190.0
        },
        {
          "name": "Other entries",
          "monthly": [
            0.0,
            0.0,
            0.0,
            100.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 100.0
        },
        {
          "name": "DIFERENCE",
          "monthly": [
            -72.84,
            51.76,
            476.36,
            445.13,
            282.69,
            537.02,
            -499.46,
            -174.99,
            27.2,
            -124.27,
            -81.7,
            47.94
          ],
          "total": 914.84
        }
      ]
    },
    "debt": {
      "items": [
        {
          "name": "Overdraft Halifax",
          "monthly": [
            1750.0,
            1800.0,
            1800.0,
            1000.0,
            1000.0,
            1300.0,
            1750.0,
            1750.0,
            1750.0,
            1750.0,
            1750.0,
            0.0
          ],
          "total": 17400.0
        },
        {
          "name": "Capital one card",
          "monthly": [
            2711.44,
            2647.0,
            2594.0,
            2529.03,
            2454.5,
            2400.0,
            2608.0,
            2560.0,
            2738.0,
            2738.0,
            2597.52,
            0.0
          ],
          "total": 28577.49
        },
        {
          "name": "Marbles card",
          "monthly": [
            4096.57,
            4233.0,
            4074.0,
            3800.0,
            4028.17,
            4200.0,
            4073.44,
            3900.0,
            3617.0,
            3617.0,
            3361.61,
            0.0
          ],
          "total": 43000.79
        },
        {
          "name": "Car",
          "monthly": [
            8500.0,
            7525.25,
            7224.64,
            6924.03,
            6500.0,
            6200.0,
            5900.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 48773.92
        }
      ]
    },
    "monthly_totals": {}
  },
  "2025": {
    "expenses": {
      "HOME": [
        {
          "name": "HOUSE RENT",
          "monthly": [
            995.0,
            995.0,
            995.0,
            995.0,
            995.0,
            995.0,
            995.0,
            995.0,
            995.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 8955.0
        },
        {
          "name": "COUNCIL TAX",
          "monthly": [
            142.0,
            0.0,
            0.0,
            146.58,
            149.0,
            149.0,
            149.0,
            149.0,
            149.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 1033.58
        }
      ],
      "UTILITIES": [
        {
          "name": "Electricity/GAS",
          "monthly": [
            212.81,
            212.81,
            232.12,
            232.12,
            232.12,
            232.12,
            232.12,
            232.12,
            232.12,
            0.0,
            0.0,
            0.0
          ],
          "total": 2050.46
        },
        {
          "name": "WATER",
          "monthly": [
            60.0,
            60.0,
            60.0,
            85.0,
            85.0,
            85.0,
            85.0,
            85.0,
            85.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 690.0
        },
        {
          "name": "INTERNET",
          "monthly": [
            23.21,
            31.0,
            31.0,
            31.0,
            33.12,
            33.12,
            33.12,
            33.32,
            33.32,
            0.0,
            0.0,
            0.0
          ],
          "total": 282.21
        }
      ],
      "CAR/TRANSPORTS": [
        {
          "name": "CAR CREDIT",
          "monthly": [
            300.61,
            300.61,
            300.61,
            300.61,
            300.61,
            300.61,
            181.09,
            181.09,
            181.09,
            0.0,
            0.0,
            0.0
          ],
          "total": 2346.9300000000003
        },
        {
          "name": "FUEL",
          "monthly": [
            60.0,
            100.0,
            150.0,
            150.0,
            150.0,
            150.0,
            40.0,
            73.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 873.0
        }
      ],
      "MAINTENANCE": [],
      "MOT": [],
      "PARKING": [],
      "OTHERS": [
        {
          "name": "Andre Alowance",
          "monthly": [
            60.0,
            60.0,
            60.0,
            60.0,
            60.0,
            50.0,
            40.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 390.0
        },
        {
          "name": "Lourenco Alowance",
          "monthly": [
            10.0,
            10.0,
            10.0,
            10.0,
            10.0,
            10.0,
            15.0,
            15.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 90.0
        },
        {
          "name": "Mobile Ricardo",
          "monthly": [
            12.73,
            12.73,
            12.73,
            12.73,
            14.53,
            14.53,
            14.53,
            14.53,
            14.53,
            0.0,
            0.0,
            0.0
          ],
          "total": 123.57
        },
        {
          "name": "Mobile Lou",
          "monthly": [
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            5.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 45.0
        },
        {
          "name": "Mobile Andre",
          "monthly": [
            12.73,
            12.73,
            12.73,
            12.73,
            12.73,
            12.73,
            12.73,
            12.73,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 101.84
        },
        {
          "name": "POA",
          "monthly": [
            16.0,
            16.0,
            16.0,
            16.0,
            16.0,
            16.0,
            16.0,
            16.0,
            16.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 144.0
        }
      ],
      "EDUCATION": [
        {
          "name": "Ricardo Course",
          "monthly": [
            119.38,
            119.38,
            119.38,
            119.38,
            119.38,
            119.38,
            119.38,
            119.38,
            119.38,
            0.0,
            0.0,
            0.0
          ],
          "total": 1074.42
        }
      ],
      "MATERIAL": [
        {
          "name": "capital one card",
          "monthly": [
            148.14,
            153.12,
            154.97,
            145.58,
            138.21,
            53.49,
            5.0,
            5.0,
            8.16,
            0.0,
            0.0,
            0.0
          ],
          "total": 811.67
        },
        {
          "name": "Marbles card",
          "monthly": [
            224.7,
            208.17,
            207.0,
            171.22,
            169.55,
            76.05,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 1056.69
        },
        {
          "name": "Asda Credit Loan 36 M",
          "monthly": [
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            272.0,
            272.0,
            272.0,
            272.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 1088.0
        },
        {
          "name": "Portugal House Loan (Hastings)",
          "monthly": [
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            145.99,
            145.99,
            0.0,
            0.0,
            0.0
          ],
          "total": 291.98
        },
        {
          "name": "Nest",
          "monthly": [
            6.0,
            6.0,
            6.0,
            6.0,
            6.0,
            6.0,
            6.0,
            6.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 48.0
        }
      ],
      "EZVIZ": [],
      "HOLIDAYS": [
        {
          "name": "Extra payments",
          "monthly": [
            0.0,
            0.0,
            0.0,
            300.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 300.0
        },
        {
          "name": "Sofa credit",
          "monthly": [
            88.08,
            88.08,
            88.08,
            88.08,
            88.08,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 440.4
        },
        {
          "name": "Spotify Family",
          "monthly": [
            0.0,
            0.0,
            0.0,
            0.0,
            19.99,
            19.99,
            19.99,
            19.99,
            19.99,
            0.0,
            0.0,
            0.0
          ],
          "total": 99.94999999999999
        }
      ],
      "SAVINGS": [
        {
          "name": "TOTTAL BANKS",
          "monthly": [
            466.92,
            455.37,
            456.05,
            710.88,
            421.83,
            427.53,
            302.99,
            448.98,
            446.14,
            0.0,
            0.0,
            0.0
          ],
          "total": 4136.69
        }
      ],
      "HOBBIES/HOLIDAYS": [],
      "INSURENCES": [
        {
          "name": "Life insurence",
          "monthly": [
            20.62,
            20.62,
            20.62,
            20.62,
            20.62,
            20.62,
            20.62,
            20.62,
            20.62,
            0.0,
            0.0,
            0.0
          ],
          "total": 185.58
        },
        {
          "name": "Car insurance",
          "monthly": [
            79.28,
            79.28,
            79.28,
            79.28,
            79.28,
            79.28,
            0.0,
            59.17,
            59.17,
            0.0,
            0.0,
            0.0
          ],
          "total": 594.02
        }
      ]
    },
    "income": {
      "items": [
        {
          "name": "Salary",
          "monthly": [
            2733.0,
            2667.0,
            2716.85,
            2700.0,
            2712.0,
            2700.0,
            2703.0,
            2550.0,
            2702.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 24183.85
        },
        {
          "name": "Ana Car",
          "monthly": [
            175.0,
            175.0,
            175.0,
            175.0,
            175.0,
            175.0,
            150.0,
            120.0,
            100.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 1420.0
        },
        {
          "name": "Casa Caparica",
          "monthly": [
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            80.0,
            80.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 160.0
        },
        {
          "name": "Other entries",
          "monthly": [
            0.0,
            0.0,
            0.0,
            0.0,
            44.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 44.0
        }
      ]
    },
    "debt": {
      "items": [
        {
          "name": "Overdraft Halifax",
          "monthly": [
            0.0,
            1850.0,
            1850.0,
            1850.0,
            1850.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 7400.0
        },
        {
          "name": "Capital one card",
          "monthly": [
            0.0,
            2768.62,
            2804.16,
            2423.55,
            2277.39,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 10273.72
        },
        {
          "name": "Marbles card",
          "monthly": [
            0.0,
            3060.29,
            2900.0,
            2860.2,
            2669.2,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 11489.689999999999
        },
        {
          "name": "Car",
          "monthly": [
            0.0,
            3998.0,
            3650.0,
            3400.0,
            1868.15,
            1868.15,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 14784.3
        },
        {
          "name": "Argos",
          "monthly": [
            0.0,
            793.99,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "total": 793.99
        }
      ]
    },
    "monthly_totals": {}
  },
  "metadata": {
    "extracted_at": "2025-12-28T14:44:59.073798",
    "years": [
      "2024",
      "2025"
    ]
  }
};

        // Load from localStorage
        const savedData = localStorage.getItem('financeData');
        if (savedData) {
            FINANCE_DATA = JSON.parse(savedData);
        }

        // Global state
        let currentYear = 2025;
        let currentMonth = new Date().getMonth();
        let cashFlowChart;

        // Save data
        function saveData() {
            // Save to localStorage (as backup)
            localStorage.setItem('financeData', JSON.stringify(FINANCE_DATA));
            console.log('‚úÖ Data saved locally');
            
            // Auto-save to cloud (with 2-second debounce)
            autoSaveToCloud('financeData', JSON.stringify(FINANCE_DATA));
            
            // Auto-sync to Google Drive if connected
            if (driveFileId) {
                syncToGoogleDrive();
            }
        }
        
        // Load data from cloud (or localStorage as fallback)
        async function loadDataFromCloud() {
            try {
                console.log('üîÑ Checking for cloud data...');
                
                // Try loading from cloud using CloudStorage
                const cloudData = await CloudStorage.loadFromCloud('financeData');
                
                if (cloudData) {
                    // Cloud data exists!
                    FINANCE_DATA = JSON.parse(cloudData);
                    console.log('‚úÖ Loaded data from cloud');
                    
                    // Also save to localStorage as backup
                    localStorage.setItem('financeData', cloudData);
                    return;
                }
                
                // No cloud data, load from localStorage
                console.log('‚ÑπÔ∏è No cloud data found, using localStorage');
                const localData = localStorage.getItem('financeData');
                if (localData) {
                    FINANCE_DATA = JSON.parse(localData);
                    console.log('‚úÖ Loaded data from localStorage');
                }
                
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                // Fallback to localStorage on error
                const localData = localStorage.getItem('financeData');
                if (localData) {
                    FINANCE_DATA = JSON.parse(localData);
                    console.log('‚úÖ Loaded data from localStorage (fallback)');
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Finance Manager Loading...');
            
            // Try to load from cloud first
            await loadDataFromCloud();
            
            // REMOVED: initializeRecurringExpenses() - was causing deleted expenses to come back
            initializeDashboard();
            gapiLoaded();
            gisLoaded();
            
            // Load saved OpenAI key
            const savedOpenAIKey = localStorage.getItem('openaiKey');
            if (savedOpenAIKey) {
                document.getElementById('openaiKeyInput').value = savedOpenAIKey;
            }
            
            // Load saved personal profile
            const savedProfile = localStorage.getItem('personalProfile');
            if (savedProfile) {
                const profile = JSON.parse(savedProfile);
                if (profile.job) document.getElementById('profileJob').value = profile.job;
                if (profile.salary) document.getElementById('profileSalary').value = profile.salary;
                if (profile.careerGoals) document.getElementById('profileCareerGoals').value = profile.careerGoals;
                if (profile.sideBusiness) document.getElementById('profileSideBusiness').value = profile.sideBusiness;
                if (profile.location) document.getElementById('profileLocation').value = profile.location;
                if (profile.context) document.getElementById('profileContext').value = profile.context;
            }
            
            // Setup goal type change listener
            const goalTypeSelect = document.getElementById('goalType');
            if (goalTypeSelect) {
                goalTypeSelect.addEventListener('change', function() {
                    const customDiv = document.getElementById('customGoalName');
                    if (this.value === 'Custom') {
                        customDiv.style.display = 'block';
                        document.getElementById('goalCustomName').required = true;
                    } else {
                        customDiv.style.display = 'none';
                        document.getElementById('goalCustomName').required = false;
                    }
                });
            }
        });

        // ===== RECURRING EXPENSES LOGIC =====
        
        // REMOVED: initializeRecurringExpenses() function
        // This function was automatically scanning historical data and recreating deleted expenses
        // Import/Export now handles recurring expenses properly

        function autoPopulateMonthlyBills(year, month) {
            const recurringExpenses = JSON.parse(localStorage.getItem('recurringExpenses') || '[]');
            
            // Ensure year exists in data
            if (!FINANCE_DATA[year]) {
                FINANCE_DATA[year] = {
                    expenses: {},
                    income: { items: [] },
                    debt: { items: [] }
                };
            }
            
            // Add each recurring expense to this month if not already there
            recurringExpenses.forEach(recurring => {
                const category = recurring.category;
                
                // Ensure category exists
                if (!FINANCE_DATA[year].expenses[category]) {
                    FINANCE_DATA[year].expenses[category] = [];
                }
                
                // Find or create the expense item
                let item = FINANCE_DATA[year].expenses[category].find(i => i.name === recurring.name);
                
                if (!item) {
                    // Create new item
                    item = {
                        name: recurring.name,
                        monthly: Array(12).fill(0),
                        total: 0,
                        isRecurring: true
                    };
                    FINANCE_DATA[year].expenses[category].push(item);
                }
                
                // If this month is empty, populate with average amount
                if (item.monthly[month] === 0) {
                    item.monthly[month] = recurring.avgAmount;
                    item.total = item.monthly.reduce((sum, val) => sum + val, 0);
                }
            });
            
            saveData();
        }

        function openAddRecurringModal() {
            document.getElementById('addRecurringModal').classList.add('active');
        }

        function addRecurringExpense(event) {
            event.preventDefault();
            
            const category = document.getElementById('recurringCategory').value;
            const name = document.getElementById('recurringName').value.trim();
            const amount = parseFloat(document.getElementById('recurringAmount').value);
            const dueDay = parseInt(document.getElementById('recurringDueDay').value) || null;
            
            const recurringExpenses = JSON.parse(localStorage.getItem('recurringExpenses') || '[]');
            
            // Check if already exists
            const existing = recurringExpenses.find(e => e.name === name && e.category === category);
            if (existing) {
                alert('‚ùå This recurring expense already exists');
                return;
            }
            
            // Add new recurring expense
            recurringExpenses.push({
                name: name,
                category: category,
                avgAmount: amount,
                dueDay: dueDay,
                isRecurring: true
            });
            
            localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
            autoSaveToCloud('recurringExpenses', JSON.stringify(recurringExpenses));
            
            // Close modal
            closeModal('addRecurringModal');
            
            const dueDayMsg = dueDay ? ` (Due: ${dueDay}${getDaySuffix(dueDay)})` : '';
            alert(`‚úÖ Added recurring expense: ${name} - ¬£${amount.toFixed(2)}/month${dueDayMsg}`);
            
            // Reload expenses page
            loadExpensesPage();
        }

        function editRecurringAmount(index) {
            const recurringExpenses = JSON.parse(localStorage.getItem('recurringExpenses') || '[]');
            const expense = recurringExpenses[index];
            
            const newAmount = prompt(
                `Edit monthly amount for ${expense.name}:`,
                expense.avgAmount.toFixed(2)
            );
            
            if (newAmount === null) return;
            
            const parsedAmount = parseFloat(newAmount);
            if (isNaN(parsedAmount) || parsedAmount < 0) {
                alert('‚ùå Please enter a valid positive number');
                return;
            }
            
            expense.avgAmount = parsedAmount;
            localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
            
            alert(`‚úÖ Updated ${expense.name}: ¬£${parsedAmount.toFixed(2)}/month`);
            loadExpensesPage();
        }

        function deleteRecurring(index) {
            const recurringExpenses = JSON.parse(localStorage.getItem('recurringExpenses') || '[]');
            const expense = recurringExpenses[index];
            
            if (!confirm(`Remove "${expense.name}" from recurring expenses?\n\nExisting entries won't be deleted, but it won't auto-populate in future months.`)) {
                return;
            }
            
            recurringExpenses.splice(index, 1);
            localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
            
            alert(`‚úÖ Removed ${expense.name} from recurring expenses`);
            loadExpensesPage();
        }

        function openEditRecurringModal(index) {
            const recurringExpenses = JSON.parse(localStorage.getItem('recurringExpenses') || '[]');
            const expense = recurringExpenses[index];
            
            if (!expense) {
                alert('‚ùå Expense not found');
                return;
            }
            
            // Populate form fields
            document.getElementById('editRecurringIndex').value = index;
            document.getElementById('editRecurringCategory').value = expense.category;
            document.getElementById('editRecurringName').value = expense.name;
            document.getElementById('editRecurringAmount').value = expense.avgAmount;
            document.getElementById('editRecurringDueDay').value = expense.dueDay || '';
            
            // Open modal
            document.getElementById('editRecurringModal').classList.add('active');
        }

        function updateRecurringExpense(event) {
            event.preventDefault();
            
            const index = parseInt(document.getElementById('editRecurringIndex').value);
            const category = document.getElementById('editRecurringCategory').value;
            const name = document.getElementById('editRecurringName').value.trim();
            const amount = parseFloat(document.getElementById('editRecurringAmount').value);
            const dueDay = parseInt(document.getElementById('editRecurringDueDay').value) || null;
            
            const recurringExpenses = JSON.parse(localStorage.getItem('recurringExpenses') || '[]');
            
            if (!recurringExpenses[index]) {
                alert('‚ùå Expense not found');
                return;
            }
            
            // Update the expense
            recurringExpenses[index] = {
                name: name,
                category: category,
                avgAmount: amount,
                dueDay: dueDay,
                isRecurring: true
            };
            
            localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
            
            // Close modal
            closeModal('editRecurringModal');
            
            alert(`‚úÖ Updated recurring expense: ${name}`);
            
            // Reload expenses page
            loadExpensesPage();
        }

        function markAsPaid(year, month, category, itemName, isPaid) {
            // Initialize payment tracking
            if (!FINANCE_DATA.payments) {
                FINANCE_DATA.payments = {};
            }
            
            const key = `${year}-${month}-${category}-${itemName}`;
            const wasPreviouslyPaid = FINANCE_DATA.payments[key] || false;
            
            FINANCE_DATA.payments[key] = isPaid;
            
            // Handle debt payment reduction
            const data = FINANCE_DATA[year];
            if (data && data.expenses && data.expenses[category]) {
                const item = data.expenses[category].find(i => i.name === itemName);
                
                if (item && item.debtLink && item.debtLink.type === 'debtPayment') {
                    const amount = item.monthly[month];
                    const debtIndex = item.debtLink.debtIndex;
                    
                    if (data.debt && data.debt.items[debtIndex]) {
                        if (isPaid && !wasPreviouslyPaid) {
                            // Just marked as paid - REDUCE debt
                            data.debt.items[debtIndex].total -= amount;
                            if (data.debt.items[debtIndex].monthly && data.debt.items[debtIndex].monthly[month]) {
                                data.debt.items[debtIndex].monthly[month] -= amount;
                            }
                            trackDebtTransaction(year, month, debtIndex, amount, 'payment');
                            
                            console.log(`üí∞ Debt reduced by ¬£${amount} for ${data.debt.items[debtIndex].name}`);
                            alert(`‚úÖ Marked as paid!\n\nüí∞ ${data.debt.items[debtIndex].name} reduced by ¬£${amount.toFixed(2)}\nNew balance: ¬£${data.debt.items[debtIndex].total.toFixed(2)}`);
                        } else if (!isPaid && wasPreviouslyPaid) {
                            // Unmarked - ADD debt back
                            data.debt.items[debtIndex].total += amount;
                            if (data.debt.items[debtIndex].monthly && data.debt.items[debtIndex].monthly[month]) {
                                data.debt.items[debtIndex].monthly[month] += amount;
                            }
                            
                            console.log(`üí∞ Debt increased by ¬£${amount} (payment unmarked) for ${data.debt.items[debtIndex].name}`);
                        }
                    }
                }
            }
            
            saveData();
        }

        function isMarkedPaid(year, month, category, itemName) {
            if (!FINANCE_DATA.payments) return false;
            const key = `${year}-${month}-${category}-${itemName}`;
            return FINANCE_DATA.payments[key] || false;
        }

        // ===== HELPER FUNCTIONS FOR DEBT INTEGRATION =====

        function getDaySuffix(day) {
            if (!day) return '';
            const j = day % 10;
            const k = day % 100;
            if (j === 1 && k !== 11) return 'st';
            if (j === 2 && k !== 12) return 'nd';
            if (j === 3 && k !== 13) return 'rd';
            return 'th';
        }

        function updatePaymentOptions() {
            const paymentType = document.querySelector('input[name="paymentType"]:checked').value;
            
            // Show/hide sections based on selection
            document.getElementById('creditCardSection').style.display = 
                paymentType === 'creditCard' ? 'block' : 'none';
            document.getElementById('debtPaymentSection').style.display = 
                paymentType === 'debtPayment' ? 'block' : 'none';
        }

        function populateDebtDropdowns(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // Clear existing options except first one
            select.innerHTML = '<option value="">Select debt...</option>';
            
            // Get debts from current year
            const year = parseInt(document.getElementById('expenseYear').value) || currentYear;
            const data = FINANCE_DATA[year];
            
            if (!data || !data.debt || !data.debt.items || data.debt.items.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No debts found - add debt first';
                option.disabled = true;
                select.appendChild(option);
                return;
            }
            
            // Add each debt as an option
            data.debt.items.forEach((debt, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${debt.name} (¬£${debt.total.toFixed(2)})`;
                select.appendChild(option);
            });
        }

        function trackDebtTransaction(year, month, debtIndex, amount, type) {
            // Initialize debtHistory if it doesn't exist
            let debtHistory = JSON.parse(localStorage.getItem('debtHistory') || '{}');
            
            const monthKey = `${year}-${month}`;
            
            if (!debtHistory[monthKey]) {
                debtHistory[monthKey] = {
                    payments: 0,
                    charges: 0,
                    transactions: []
                };
            }
            
            // Track transaction
            if (type === 'charge') {
                debtHistory[monthKey].charges += amount;
            } else if (type === 'payment') {
                debtHistory[monthKey].payments += amount;
            }
            
            // Log transaction
            debtHistory[monthKey].transactions.push({
                debtIndex: debtIndex,
                amount: amount,
                type: type,
                timestamp: new Date().toISOString()
            });
            
            localStorage.setItem('debtHistory', JSON.stringify(debtHistory));
            autoSaveToCloud('debtHistory', JSON.stringify(debtHistory));
            console.log(`üìä Debt transaction tracked: ${type} of ¬£${amount} for debt ${debtIndex}`);
        }

        // ===== NAVIGATION =====
        
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById(pageName + '-page').classList.remove('hidden');
            event.currentTarget.classList.add('active');
            
            // Update header title
            const pageTitles = {
                'dashboard': 'Financial Dashboard',
                'monthly': 'Monthly View',
                'expenses': 'Expenses',
                'income': 'Income',
                'debt': 'Debt Tracker',
                'budget': 'Budget',
                'goals': 'Goals',
                'insights': 'AI Insights',
                'reports': 'Reports',
                'settings': 'Settings'
            };
            const headerTitle = document.getElementById('page-title');
            if (headerTitle) {
                headerTitle.textContent = pageTitles[pageName] || 'FinanceIQ';
            }
            
            loadPageContent(pageName);
        }

        function loadPageContent(pageName) {
            switch(pageName) {
                case 'dashboard':
                    initializeDashboard();
                    break;
                case 'monthly':
                    loadMonthlyView();
                    break;
                case 'expenses':
                    loadExpensesPage();
                    break;
                case 'income':
                    loadIncomePage();
                    break;
                case 'debt':
                    loadDebtPage();
                    break;
                case 'budget':
                    loadBudgetPage();
                    break;
                case 'goals':
                    loadGoalsPage();
                    break;
                case 'insights':
                    loadInsightsPage();
                    break;
                case 'reports':
                    loadReportsPage();
                    break;
                case 'settings':
                    loadSettingsPage();
                    break;
            }
        }

        // Load Settings page and update user email
        function loadSettingsPage() {
            const emailDisplay = document.getElementById('current-user-email');
            if (emailDisplay && currentUser) {
                emailDisplay.textContent = currentUser.email;
            }
            
            // Check cloud storage status
            checkCloudStatus();
        }

        // ===== DASHBOARD =====
        
        function initializeDashboard() {
            const data2025 = FINANCE_DATA['2025'];
            
            const income = data2025.income.items ? data2025.income.items.reduce((sum, item) => sum + item.total, 0) : 0;
            
            let expenses = 0;
            Object.values(data2025.expenses).forEach(category => {
                category.forEach(item => expenses += item.total);
            });
            
            document.getElementById('totalIncome').textContent = '¬£' + income.toFixed(0);
            document.getElementById('totalExpenses').textContent = '¬£' + expenses.toFixed(0);
            document.getElementById('netPosition').textContent = '¬£' + (income - expenses).toFixed(0);
            
            // Load debt overview
            loadDashboardDebtOverview();
            
            createCashFlowChart();
        }

        function loadDashboardDebtOverview() {
            const container = document.getElementById('dashboardDebtOverview');
            const data = FINANCE_DATA[currentYear];
            
            if (!data.debt || !data.debt.items || data.debt.items.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            // Calculate total debt
            let totalDebt = 0;
            data.debt.items.forEach(item => {
                totalDebt += item.total || 0;
            });
            
            // Get debt history from localStorage (payments/charges this month)
            const debtHistory = JSON.parse(localStorage.getItem('debtHistory') || '{}');
            const currentMonthKey = `${currentYear}-${currentMonth}`;
            const monthHistory = debtHistory[currentMonthKey] || { payments: 0, charges: 0 };
            
            // Calculate net change
            const netChange = monthHistory.charges - monthHistory.payments;
            const netChangePercent = totalDebt > 0 ? (netChange / totalDebt * 100) : 0;
            
            // Find highest and lowest debts
            const sortedDebts = [...data.debt.items].sort((a, b) => b.total - a.total);
            const highestDebt = sortedDebts[0];
            const lowestDebt = sortedDebts[sortedDebts.length - 1];
            
            // Calculate debt-free timeline (rough estimate)
            const avgMonthlyPayment = monthHistory.payments || 100; // Default if no data
            const monthsToDebtFree = avgMonthlyPayment > 0 ? Math.ceil(totalDebt / avgMonthlyPayment) : 0;
            const yearsToDebtFree = (monthsToDebtFree / 12).toFixed(1);
            
            let html = `
                <!-- Total Debt Summary Card -->
                <div class="chart-card" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%); border-left: 4px solid var(--accent-red);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
                        <div>
                            <h3 class="chart-title" style="margin-bottom: 0.5rem;">üí≥ Total Debt Overview</h3>
                            <div style="font-size: 2.5rem; font-weight: 800; color: var(--accent-red); margin-bottom: 0.5rem;">
                                ¬£${totalDebt.toFixed(2)}
                            </div>
                            ${yearsToDebtFree > 0 ? `<p style="color: var(--text-secondary); font-size: 0.9rem;">Est. debt-free in ${yearsToDebtFree} years at current rate</p>` : ''}
                        </div>
                        <button class="btn btn-primary" onclick="showPage('debt')" style="white-space: nowrap;">
                            Manage Debts ‚Üí
                        </button>
                    </div>
                    
                    <!-- This Month Activity -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 1.5rem;">
                        <div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Paid This Month</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-green);">
                                ¬£${monthHistory.payments.toFixed(0)}
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem;">New Charges</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-yellow);">
                                ¬£${monthHistory.charges.toFixed(0)}
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Net Change</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${netChange > 0 ? 'var(--accent-red)' : 'var(--accent-green)'};">
                                ${netChange > 0 ? '+' : ''}¬£${netChange.toFixed(0)}
                                <span style="font-size: 0.9rem;">(${netChange > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(netChangePercent).toFixed(1)}%)</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Individual Debt Breakdown -->
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
            `;
            
            // Add each debt with progress bar
            data.debt.items.forEach((debt, index) => {
                const percentage = (debt.total / totalDebt * 100);
                const color = percentage > 50 ? 'var(--accent-red)' : percentage > 20 ? 'var(--accent-yellow)' : 'var(--accent-green)';
                
                html += `
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="font-weight: 600;">${debt.name}</span>
                                <span style="font-weight: 700; color: ${color};">¬£${debt.total.toFixed(2)}</span>
                            </div>
                            <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                                <div style="width: ${percentage}%; height: 100%; background: ${color}; transition: width 0.5s ease;"></div>
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                ${percentage.toFixed(1)}% of total debt
                                ${debt.interestRate ? ` ‚Ä¢ ${debt.interestRate}% APR` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function createCashFlowChart() {
            const ctx = document.getElementById('cashFlowChart');
            if (!ctx) return;
            
            if (cashFlowChart) cashFlowChart.destroy();
            
            const data = FINANCE_DATA[currentYear];
            
            const monthlyIncome = Array(12).fill(0);
            if (data.income.items) {
                data.income.items.forEach(item => {
                    item.monthly.forEach((amount, idx) => {
                        monthlyIncome[idx] += amount;
                    });
                });
            }
            
            const monthlyExpenses = Array(12).fill(0);
            Object.values(data.expenses).forEach(category => {
                category.forEach(item => {
                    item.monthly.forEach((amount, idx) => {
                        monthlyExpenses[idx] += amount;
                    });
                });
            });
            
            cashFlowChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [
                        {
                            label: 'Income',
                            data: monthlyIncome,
                            borderColor: '#00FFA3',
                            backgroundColor: 'rgba(0, 255, 163, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Expenses',
                            data: monthlyExpenses,
                            borderColor: '#FF4757',
                            backgroundColor: 'rgba(255, 71, 87, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: '#F7F9FC' } }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#9BA4B5' },
                            grid: { color: '#2A3142' }
                        },
                        x: {
                            ticks: { color: '#9BA4B5' },
                            grid: { color: '#2A3142' }
                        }
                    }
                }
            });
        }

        // ===== MONTHLY VIEW WITH PAID/UNPAID TRACKING =====
        
        function selectYear(year) {
            currentYear = year;
            document.querySelectorAll('.year-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            loadMonthlyView();
        }

        function selectMonth(month) {
            currentMonth = month;
            document.querySelectorAll('.month-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Auto-populate recurring expenses for this month
            autoPopulateMonthlyBills(currentYear, month);
            
            loadMonthlyView();
        }

        function loadMonthlyView() {
            const content = document.getElementById('monthlyContent');
            const data = FINANCE_DATA[currentYear];
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            let totalBills = 0;
            let paidBills = 0;
            let unpaidBills = 0;
            let totalIncome = 0;
            
            // Calculate income for this month
            if (data.income && data.income.items) {
                data.income.items.forEach(item => {
                    totalIncome += item.monthly[currentMonth] || 0;
                });
            }
            
            // Build income section
            let html = `<div class="chart-card">
                <h3 class="chart-title">${monthNames[currentMonth]} ${currentYear} - Income</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Source</th>
                            <th>Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            if (data.income && data.income.items) {
                data.income.items.forEach(item => {
                    const amount = item.monthly[currentMonth] || 0;
                    if (amount > 0) {
                        html += `<tr>
                            <td><strong>${item.name}</strong></td>
                            <td>
                                <span class="editable-amount" 
                                      onclick="editIncomeAmount('${item.name}', ${currentMonth}, ${currentYear})"
                                      style="cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 4px; transition: background 0.2s; color: var(--accent-green); font-weight: 700;"
                                      onmouseover="this.style.background='rgba(0,255,163,0.1)'"
                                      onmouseout="this.style.background='transparent'">
                                    ¬£${amount.toFixed(2)}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-danger btn-small" onclick="deleteIncome('${item.name}', ${currentMonth}, ${currentYear})">üóëÔ∏è</button>
                            </td>
                        </tr>`;
                    }
                });
            }
            
            if (totalIncome === 0) {
                html += `<tr><td colspan="2" style="text-align: center; color: var(--text-secondary);">No income added for this month. Click "Add Income" above.</td></tr>`;
            }
            
            html += `</tbody></table></div>`;
            
            // Build expenses table with paid/unpaid checkboxes
            html += `<div class="chart-card">
                <h3 class="chart-title">${monthNames[currentMonth]} ${currentYear} - Bill Tracker</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Paid?</th>
                            <th>Category</th>
                            <th>Bill Name</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            Object.entries(data.expenses).forEach(([category, items]) => {
                items.forEach((item, idx) => {
                    const amount = item.monthly[currentMonth];
                    if (amount > 0) {
                        totalBills += amount;
                        const isPaid = isMarkedPaid(currentYear, currentMonth, category, item.name);
                        
                        if (isPaid) {
                            paidBills += amount;
                        } else {
                            unpaidBills += amount;
                        }
                        
                        html += `<tr>
                            <td>
                                <input type="checkbox" 
                                       ${isPaid ? 'checked' : ''}
                                       onchange="markAsPaid(${currentYear}, ${currentMonth}, '${category}', '${item.name}', this.checked); loadMonthlyView();">
                            </td>
                            <td>${category}</td>
                            <td><strong>${item.name}</strong></td>
                            <td>
                                <span class="editable-amount" 
                                      onclick="editExpenseAmount('${category}', '${item.name}', ${currentMonth}, ${currentYear})"
                                      style="cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 4px; transition: background 0.2s;"
                                      onmouseover="this.style.background='rgba(0,255,163,0.1)'"
                                      onmouseout="this.style.background='transparent'">
                                    ¬£${amount.toFixed(2)}
                                </span>
                            </td>
                            <td>
                                ${isPaid ? '<span class="badge-paid">‚úì PAID</span>' : '<span class="badge-unpaid">‚è≥ PENDING</span>'}
                            </td>
                            <td>
                                <button class="btn btn-danger btn-small" onclick="deleteExpense('${category}', '${item.name}', ${currentMonth}, ${currentYear})">üóëÔ∏è</button>
                            </td>
                        </tr>`;
                    }
                });
            });
            
            html += '</tbody></table></div>';
            
            // Summary cards
            html = `<div class="card-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Income</div>
                    <div class="stat-value" style="color: var(--accent-green);">¬£${totalIncome.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Bills</div>
                    <div class="stat-value">¬£${totalBills.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">‚úì Paid</div>
                    <div class="stat-value" style="color: var(--accent-green);">¬£${paidBills.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">‚è≥ Pending</div>
                    <div class="stat-value" style="color: var(--accent-red);">¬£${unpaidBills.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Net This Month</div>
                    <div class="stat-value" style="color: ${totalIncome - totalBills >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">¬£${(totalIncome - totalBills).toFixed(2)}</div>
                </div>
            </div>` + html;
            
            content.innerHTML = html;
        }

        // ===== EXPENSES PAGE =====
        
        function loadExpensesPage() {
            const content = document.getElementById('expensesContent');
            const recurringExpenses = JSON.parse(localStorage.getItem('recurringExpenses') || '[]');
            
            let html = `<div class="chart-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 class="chart-title" style="margin: 0;">Recurring Expenses Management</h3>
                    <button class="btn btn-primary" onclick="openAddRecurringModal()">‚ûï Add Recurring Expense</button>
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                    These bills automatically appear each month. Just tick them off as you pay them!
                </p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Bill Name</th>
                            <th>Due Date</th>
                            <th>Avg Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            if (recurringExpenses.length === 0) {
                html += `<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">No recurring expenses. Click "Add Recurring Expense" to create one.</td></tr>`;
            } else {
                recurringExpenses.forEach((expense, index) => {
                    const dueDayDisplay = expense.dueDay 
                        ? `${expense.dueDay}${getDaySuffix(expense.dueDay)} of month`
                        : '<span style="color: var(--text-secondary);">Not set</span>';
                    
                    html += `<tr>
                        <td>${expense.category}</td>
                        <td><strong>${expense.name}</strong></td>
                        <td>${dueDayDisplay}</td>
                        <td>
                            <span class="editable-amount" 
                                  onclick="editRecurringAmount(${index})"
                                  style="cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 4px; transition: background 0.2s;"
                                  onmouseover="this.style.background='rgba(0,255,163,0.1)'"
                                  onmouseout="this.style.background='transparent'">
                                ¬£${expense.avgAmount.toFixed(2)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-primary btn-small" onclick="openEditRecurringModal(${index})" style="margin-right: 0.5rem;">‚úèÔ∏è Edit</button>
                            <button class="btn btn-danger btn-small" onclick="deleteRecurring(${index})">üóëÔ∏è Remove</button>
                        </td>
                    </tr>`;
                });
            }
            
            html += '</tbody></table></div>';
            
            content.innerHTML = html;
        }

        // ===== BUDGET PLANNING PAGE =====

        function loadBudgetPage() {
            const content = document.getElementById('budgetContent');
            const data = FINANCE_DATA[currentYear];
            
            // Get or create budget data
            let budgets = JSON.parse(localStorage.getItem('budgets') || '{}');
            if (!budgets[currentYear]) {
                budgets[currentYear] = {};
            }
            
            // Calculate actual spending by category
            let actualSpending = {};
            Object.entries(data.expenses).forEach(([category, items]) => {
                let total = 0;
                items.forEach(item => total += item.total);
                actualSpending[category] = total / 12; // Monthly average
            });
            
            // Get all unique categories
            const categories = Object.keys(data.expenses);
            
            let html = `
                <div class="card-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Monthly Budget</div>
                        <div class="stat-value" id="totalBudget">¬£0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Actual Spending (Avg)</div>
                        <div class="stat-value" id="totalActual">¬£0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Variance</div>
                        <div class="stat-value" id="variance">¬£0</div>
                    </div>
                </div>

                <div class="chart-card">
                    <h3 class="chart-title">Set Monthly Budget by Category</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                        Set a maximum monthly spending limit for each category. Get alerts when you're close to your limit.
                    </p>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Monthly Budget</th>
                                <th>Actual (Avg)</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            let totalBudget = 0;
            let totalActual = 0;
            
            categories.forEach(category => {
                const budgetAmount = budgets[currentYear][category] || 0;
                const actualAmount = actualSpending[category] || 0;
                const variance = budgetAmount - actualAmount;
                const percentage = budgetAmount > 0 ? (actualAmount / budgetAmount * 100) : 0;
                
                totalBudget += budgetAmount;
                totalActual += actualAmount;
                
                let status = '';
                if (budgetAmount === 0) {
                    status = '<span style="color: var(--text-secondary);">No budget set</span>';
                } else if (percentage > 100) {
                    status = `<span style="color: var(--accent-red);">‚ö†Ô∏è Over by ¬£${Math.abs(variance).toFixed(0)}</span>`;
                } else if (percentage > 90) {
                    status = `<span style="color: var(--accent-yellow);">‚ö° ${percentage.toFixed(0)}% used</span>`;
                } else {
                    status = `<span style="color: var(--accent-green);">‚úì ${percentage.toFixed(0)}% used</span>`;
                }
                
                html += `<tr>
                    <td><strong>${category}</strong></td>
                    <td>
                        <span class="editable-amount" 
                              onclick="setBudget('${category}')"
                              style="cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 4px; transition: background 0.2s;"
                              onmouseover="this.style.background='rgba(0,255,163,0.1)'"
                              onmouseout="this.style.background='transparent'">
                            ${budgetAmount > 0 ? '¬£' + budgetAmount.toFixed(2) : 'Click to set'}
                        </span>
                    </td>
                    <td>¬£${actualAmount.toFixed(2)}</td>
                    <td>${status}</td>
                    <td>
                        ${budgetAmount > 0 ? `<button class="btn btn-danger btn-small" onclick="clearBudget('${category}')">Clear</button>` : ''}
                    </td>
                </tr>`;
            });
            
            html += `</tbody></table></div>`;
            
            content.innerHTML = html;
            
            // Update summary cards
            const totalVariance = totalBudget - totalActual;
            document.getElementById('totalBudget').textContent = '¬£' + totalBudget.toFixed(2);
            document.getElementById('totalActual').textContent = '¬£' + totalActual.toFixed(2);
            document.getElementById('variance').textContent = '¬£' + totalVariance.toFixed(2);
            document.getElementById('variance').style.color = totalVariance >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
        }

        function setBudget(category) {
            const budgets = JSON.parse(localStorage.getItem('budgets') || '{}');
            if (!budgets[currentYear]) {
                budgets[currentYear] = {};
            }
            
            const currentBudget = budgets[currentYear][category] || 0;
            const newBudget = prompt(
                `Set monthly budget for ${category}:`,
                currentBudget > 0 ? currentBudget.toFixed(2) : ''
            );
            
            if (newBudget === null) return;
            
            const parsedBudget = parseFloat(newBudget);
            
            if (isNaN(parsedBudget) || parsedBudget < 0) {
                alert('‚ùå Please enter a valid positive number');
                return;
            }
            
            budgets[currentYear][category] = parsedBudget;
            localStorage.setItem('budgets', JSON.stringify(budgets));
            
            alert(`‚úÖ Budget set: ${category} - ¬£${parsedBudget.toFixed(2)}/month`);
            loadBudgetPage();
        }

        function clearBudget(category) {
            if (!confirm(`Clear budget for ${category}?`)) return;
            
            const budgets = JSON.parse(localStorage.getItem('budgets') || '{}');
            if (budgets[currentYear]) {
                delete budgets[currentYear][category];
                localStorage.setItem('budgets', JSON.stringify(budgets));
            }
            
            alert(`‚úÖ Budget cleared for ${category}`);
            loadBudgetPage();
        }

        // ===== REPORTS & EXPORT PAGE =====

        function loadReportsPage() {
            const content = document.getElementById('reportsContent');
            
            let html = `
                <!-- Annual Summary Report -->
                <div class="chart-card">
                    <h3 class="chart-title">üìä Annual Financial Summary</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                        Generate a comprehensive annual report with all your financial data
                    </p>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="generateAnnualReport(2024)">
                            üìÑ Generate 2024 Report
                        </button>
                        <button class="btn btn-primary" onclick="generateAnnualReport(2025)">
                            üìÑ Generate 2025 Report
                        </button>
                        <button class="btn btn-primary" onclick="generateAnnualReport(2026)">
                            üìÑ Generate 2026 Report
                        </button>
                    </div>
                    <div id="reportOutput" class="mt-2"></div>
                </div>

                <!-- Export Options -->
                <div class="chart-card">
                    <h3 class="chart-title">üì• Export Data</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                        Export your financial data in various formats
                    </p>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="exportToCSV()">
                            üìä Export to CSV (Excel)
                        </button>
                        <button class="btn btn-primary" onclick="exportToJSON()">
                            üíæ Export to JSON (Backup)
                        </button>
                        <button class="btn btn-secondary" onclick="printReport()">
                            üñ®Ô∏è Print Current Year
                        </button>
                    </div>
                </div>

                <!-- Category Breakdown -->
                <div class="chart-card">
                    <h3 class="chart-title">üìà Spending Analysis</h3>
                    <div id="categoryAnalysis"></div>
                </div>
            `;
            
            content.innerHTML = html;
            loadCategoryAnalysis();
        }

        function generateAnnualReport(year) {
            const output = document.getElementById('reportOutput');
            const data = FINANCE_DATA[year];
            
            if (!data) {
                output.innerHTML = `<p style="color: var(--accent-red); margin-top: 1.5rem;">No data available for ${year}</p>`;
                return;
            }
            
            // Calculate totals
            let totalIncome = 0;
            if (data.income && data.income.items) {
                data.income.items.forEach(item => totalIncome += item.total);
            }
            
            let totalExpenses = 0;
            let expensesByCategory = {};
            Object.entries(data.expenses).forEach(([category, items]) => {
                let categoryTotal = 0;
                items.forEach(item => {
                    totalExpenses += item.total;
                    categoryTotal += item.total;
                });
                expensesByCategory[category] = categoryTotal;
            });
            
            let totalDebt = 0;
            if (data.debt && data.debt.items) {
                data.debt.items.forEach(item => totalDebt += item.total);
            }
            
            const netPosition = totalIncome - totalExpenses;
            
            // Generate report HTML
            let report = `
                <div style="background: var(--bg-medium); padding: 2rem; border-radius: 12px; margin-top: 1.5rem;">
                    <h2 style="margin-bottom: 2rem; text-align: center; color: var(--accent-green);">
                        ${year} Financial Summary Report
                    </h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 8px;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">TOTAL INCOME</div>
                            <div style="font-size: 1.75rem; font-weight: 700; color: var(--accent-green);">¬£${totalIncome.toFixed(2)}</div>
                        </div>
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 8px;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">TOTAL EXPENSES</div>
                            <div style="font-size: 1.75rem; font-weight: 700; color: var(--accent-red);">¬£${totalExpenses.toFixed(2)}</div>
                        </div>
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 8px;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">NET POSITION</div>
                            <div style="font-size: 1.75rem; font-weight: 700; color: ${netPosition >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">¬£${netPosition.toFixed(2)}</div>
                        </div>
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 8px;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">TOTAL DEBT</div>
                            <div style="font-size: 1.75rem; font-weight: 700; color: var(--accent-yellow);">¬£${totalDebt.toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Expenses by Category</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border);">
                                <th style="text-align: left; padding: 0.75rem;">Category</th>
                                <th style="text-align: right; padding: 0.75rem;">Amount</th>
                                <th style="text-align: right; padding: 0.75rem;">% of Total</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            Object.entries(expensesByCategory)
                .sort((a, b) => b[1] - a[1])
                .forEach(([category, amount]) => {
                    const percentage = (amount / totalExpenses * 100).toFixed(1);
                    report += `
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 0.75rem;"><strong>${category}</strong></td>
                            <td style="text-align: right; padding: 0.75rem;">¬£${amount.toFixed(2)}</td>
                            <td style="text-align: right; padding: 0.75rem;">${percentage}%</td>
                        </tr>`;
                });
            
            report += `
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--border); text-align: center; color: var(--text-secondary);">
                        <p>Report generated on ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                </div>`;
            
            output.innerHTML = report;
        }

        function exportToCSV() {
            const year = currentYear;
            const data = FINANCE_DATA[year];
            
            if (!data) {
                alert('‚ùå No data available for ' + year);
                return;
            }
            
            let csv = `FinanceIQ Export - ${year}\n\n`;
            
            // Income section
            csv += 'INCOME\n';
            csv += 'Source,Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec,Total\n';
            if (data.income && data.income.items) {
                data.income.items.forEach(item => {
                    csv += `${item.name},`;
                    csv += item.monthly.join(',') + ',';
                    csv += item.total + '\n';
                });
            }
            csv += '\n';
            
            // Expenses section
            csv += 'EXPENSES\n';
            csv += 'Category,Item,Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec,Total\n';
            Object.entries(data.expenses).forEach(([category, items]) => {
                items.forEach(item => {
                    csv += `${category},${item.name},`;
                    csv += item.monthly.join(',') + ',';
                    csv += item.total + '\n';
                });
            });
            csv += '\n';
            
            // Debt section
            csv += 'DEBT\n';
            csv += 'Name,Amount,Interest Rate\n';
            if (data.debt && data.debt.items) {
                data.debt.items.forEach(item => {
                    csv += `${item.name},${item.total},${item.interestRate || 'N/A'}\n`;
                });
            }
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `FinanceIQ_${year}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            alert('‚úÖ CSV file downloaded successfully!');
        }

        function exportToJSON() {
            const dataStr = JSON.stringify(FINANCE_DATA, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `FinanceIQ_Backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert('‚úÖ JSON backup downloaded successfully!');
        }

        function printReport() {
            generateAnnualReport(currentYear);
            setTimeout(() => {
                window.print();
            }, 500);
        }

        function loadCategoryAnalysis() {
            const container = document.getElementById('categoryAnalysis');
            const data = FINANCE_DATA[currentYear];
            
            let totalExpenses = 0;
            let expensesByCategory = {};
            
            Object.entries(data.expenses).forEach(([category, items]) => {
                let categoryTotal = 0;
                items.forEach(item => {
                    totalExpenses += item.total;
                    categoryTotal += item.total;
                });
                expensesByCategory[category] = categoryTotal;
            });
            
            let html = '<table class="data-table"><thead><tr><th>Category</th><th>Amount</th><th>% of Total</th><th>Monthly Avg</th></tr></thead><tbody>';
            
            Object.entries(expensesByCategory)
                .sort((a, b) => b[1] - a[1])
                .forEach(([category, amount]) => {
                    const percentage = (amount / totalExpenses * 100).toFixed(1);
                    const monthlyAvg = amount / 12;
                    html += `<tr>
                        <td><strong>${category}</strong></td>
                        <td>¬£${amount.toFixed(2)}</td>
                        <td>${percentage}%</td>
                        <td>¬£${monthlyAvg.toFixed(2)}</td>
                    </tr>`;
                });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ===== INCOME PAGE =====
        
        function loadIncomePage() {
            const content = document.getElementById('incomeContent');
            const data = FINANCE_DATA[currentYear];
            
            let html = `<div class="chart-card">
                <h3 class="chart-title">${currentYear} Income Sources</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Source</th>
                            <th>Annual Total</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            if (data.income.items && data.income.items.length > 0) {
                data.income.items.forEach((item, index) => {
                    html += `<tr>
                        <td><strong>${item.name}</strong></td>
                        <td>¬£${item.total.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-danger btn-small" onclick="deleteIncomeSource(${index})">üóëÔ∏è Delete</button>
                        </td>
                    </tr>`;
                });
            } else {
                html += `<tr><td colspan="3" style="text-align: center; color: var(--text-secondary);">No income sources for ${currentYear}. Use Monthly View to add income.</td></tr>`;
            }
            
            html += '</tbody></table></div>';
            content.innerHTML = html;
        }

        function deleteIncomeSource(index) {
            const data = FINANCE_DATA[currentYear];
            const item = data.income.items[index];
            
            if (!confirm(`Delete income source "${item.name}"?\n\nThis will remove it completely from ${currentYear} (all months).`)) {
                return;
            }
            
            console.log('Deleting income source:', item.name);
            
            // Remove from array
            data.income.items.splice(index, 1);
            
            // Save
            saveData();
            
            alert(`‚úÖ Deleted income source: ${item.name}`);
            
            // Reload income page
            loadIncomePage();
        }

        // ===== DEBT TRACKER PAGE =====

        function loadDebtPage() {
            const content = document.getElementById('debtContent');
            const data = FINANCE_DATA[currentYear];
            
            // Calculate debt statistics
            let totalDebt = 0;
            let debtCount = 0;
            
            if (data.debt && data.debt.items) {
                data.debt.items.forEach(item => {
                    totalDebt += item.total || 0;
                    debtCount++;
                });
            }
            
            // Summary cards
            let html = `<div class="card-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Debt</div>
                    <div class="stat-value" style="color: var(--accent-red);">¬£${totalDebt.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Number of Debts</div>
                    <div class="stat-value">${debtCount}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Average Debt</div>
                    <div class="stat-value">¬£${debtCount > 0 ? (totalDebt / debtCount).toFixed(2) : '0.00'}</div>
                </div>
            </div>`;
            
            // Debt table
            html += `<div class="chart-card">
                <h3 class="chart-title">All Debts - ${currentYear}</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Debt Name</th>
                            <th>Amount Owed</th>
                            <th>Est. Interest Rate</th>
                            <th>Priority</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            if (data.debt && data.debt.items && data.debt.items.length > 0) {
                // Sort debts by amount (highest first for avalanche method)
                const sortedDebts = [...data.debt.items].sort((a, b) => b.total - a.total);
                
                sortedDebts.forEach((item, index) => {
                    const priority = index < 2 ? 'üî¥ HIGH' : index < 4 ? 'üü° MEDIUM' : 'üü¢ LOW';
                    const interestRate = item.interestRate || getEstimatedInterestRate(item.name);
                    const originalIndex = data.debt.items.findIndex(d => d.name === item.name);
                    
                    html += `<tr>
                        <td><strong>${item.name}</strong></td>
                        <td style="color: var(--accent-red); font-weight: 700;">¬£${item.total.toFixed(2)}</td>
                        <td>${interestRate}</td>
                        <td>${priority}</td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-secondary btn-small" onclick="editDebt(${originalIndex})">‚úèÔ∏è Edit</button>
                                <button class="btn btn-danger btn-small" onclick="deleteDebt(${originalIndex})">üóëÔ∏è Delete</button>
                            </div>
                        </td>
                    </tr>`;
                });
            } else {
                html += `<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">No debt data available for ${currentYear}. Click "Add Debt" to start tracking.</td></tr>`;
            }
            
            html += `</tbody></table></div>`;
            
            // Debt repayment recommendations
            html += `<div class="chart-card" style="background: linear-gradient(135deg, rgba(255, 71, 87, 0.1), rgba(255, 217, 61, 0.1)); border: 2px solid var(--accent-red);">
                <h3 class="chart-title">ü§ñ AI-Powered Debt Repayment Strategy</h3>
                <button class="btn btn-primary" onclick="generateAIDebtStrategy()" style="margin-bottom: 1.5rem;">
                    Generate Optimal Repayment Plan with AI
                </button>
                <div id="aiDebtStrategyOutput" style="line-height: 1.8;"></div>
            </div>`;
            
            // Basic recommendations (fallback)
            html += `<div class="chart-card" style="background: linear-gradient(135deg, rgba(0, 255, 163, 0.05), rgba(0, 153, 255, 0.05));">
                <h3 class="chart-title">üí° Quick Debt Tips</h3>
                <div style="line-height: 1.8;">
                    <p style="margin-bottom: 1rem;"><strong>Recommended Approach: Debt Avalanche Method</strong></p>
                    <p style="margin-bottom: 1rem;">Focus on paying off highest interest debts first while maintaining minimum payments on others.</p>
                    <p style="margin-bottom: 1rem;"><strong>Priority Order (by interest rate):</strong></p>
                    <ol style="margin-left: 1.5rem; margin-bottom: 1rem;">`;
            
            if (data.debt && data.debt.items && data.debt.items.length > 0) {
                const sortedByInterest = [...data.debt.items].sort((a, b) => {
                    const rateA = parseFloat((a.interestRate || getEstimatedInterestRate(a.name)).toString().split('-')[0]);
                    const rateB = parseFloat((b.interestRate || getEstimatedInterestRate(b.name)).toString().split('-')[0]);
                    return rateB - rateA;
                });
                
                sortedByInterest.forEach((item, index) => {
                    const rate = item.interestRate || getEstimatedInterestRate(item.name);
                    html += `<li style="margin-bottom: 0.5rem;"><strong>${item.name}</strong> - ¬£${item.total.toFixed(2)} (${rate}%)</li>`;
                });
            }
            
            html += `</ol>
                    <p style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                        <strong>üí∞ Monthly Payment Recommendation:</strong><br>
                        Aim to pay ¬£${(totalDebt * 0.05).toFixed(2)} total per month (5% of total debt) to clear in ~20 months.
                    </p>
                </div>
            </div>`;
            
            content.innerHTML = html;
        }

        function getEstimatedInterestRate(debtName) {
            const name = debtName.toLowerCase();
            
            // Estimate interest rates based on debt type
            if (name.includes('card') || name.includes('credit')) {
                return '18-25%';
            } else if (name.includes('overdraft')) {
                return '15-20%';
            } else if (name.includes('loan') || name.includes('car')) {
                return '8-12%';
            } else if (name.includes('mortgage') || name.includes('house')) {
                return '3-5%';
            } else {
                return '10-15%';
            }
        }

        // ===== AI DEBT STRATEGY =====

        async function generateAIDebtStrategy() {
            const apiKey = localStorage.getItem('openaiKey');
            if (!apiKey) {
                alert('‚ùå Please add your OpenAI API key in Settings first');
                return;
            }

            const output = document.getElementById('aiDebtStrategyOutput');
            output.innerHTML = '<div style="text-align: center; padding: 2rem;"><div style="border: 4px solid var(--border); border-top-color: var(--accent-green); border-radius: 50%; width: 48px; height: 48px; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div><p>AI is analyzing your debt situation...</p></div><style>@keyframes spin { to { transform: rotate(360deg); }}</style>';

            const data = FINANCE_DATA[currentYear];
            
            // Prepare debt information
            let debtList = '';
            let totalDebt = 0;
            
            if (data.debt && data.debt.items && data.debt.items.length > 0) {
                data.debt.items.forEach((item, index) => {
                    const rate = item.interestRate || getEstimatedInterestRate(item.name);
                    debtList += `${index + 1}. ${item.name}: ¬£${item.total.toFixed(2)} at ${rate} interest\n`;
                    totalDebt += item.total;
                });
            } else {
                output.innerHTML = '<p style="color: var(--accent-red);">No debt data available. Add some debts first!</p>';
                return;
            }

            // Calculate income and expenses
            let totalIncome = 0;
            if (data.income && data.income.items) {
                data.income.items.forEach(item => {
                    totalIncome += item.total;
                });
            }

            let totalExpenses = 0;
            Object.values(data.expenses).forEach(category => {
                category.forEach(item => {
                    totalExpenses += item.total;
                });
            });

            const monthlyIncome = totalIncome / 12;
            const monthlyExpenses = totalExpenses / 12;
            const monthlyAvailable = monthlyIncome - monthlyExpenses;

            const personalContext = getPersonalProfileContext();

            const prompt = `As a UK debt management expert, create a detailed, actionable debt repayment strategy:
${personalContext}
**Current Financial Situation:**
- Total Debt: ¬£${totalDebt.toFixed(2)}
- Monthly Income: ¬£${monthlyIncome.toFixed(2)}
- Monthly Expenses: ¬£${monthlyExpenses.toFixed(2)}
- Available for Debt Repayment: ¬£${Math.abs(monthlyAvailable).toFixed(2)}${monthlyAvailable < 0 ? ' (DEFICIT - need to reduce expenses)' : ''}

**Debts:**
${debtList}

**Provide:**
1. **Best Strategy** (Avalanche vs Snowball - which suits this situation)
2. **Priority Order** (exact order to tackle these debts)
3. **Monthly Allocation** (specific ¬£ amounts to each debt)
4. **Timeline** (when each debt clears)
5. **Quick Wins** (balance transfers, 0% cards, negotiation tips specific to UK)
6. **Warnings** (common mistakes to avoid)

Consider their career situation and side business in your recommendations. Be specific with numbers. Keep under 400 words. UK context only.`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            { 
                                role: 'system', 
                                content: 'You are a knowledgeable UK debt management advisor providing practical, actionable advice.' 
                            },
                            { 
                                role: 'user', 
                                content: prompt 
                            }
                        ],
                        max_tokens: 800,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.choices && result.choices[0] && result.choices[0].message) {
                    const aiResponse = result.choices[0].message.content;
                    output.innerHTML = `<div style="white-space: pre-line; background: rgba(0, 255, 163, 0.05); padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--accent-green);">${aiResponse}</div>
                        <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-secondary);">‚ú® Generated by AI - Always verify advice with a qualified financial advisor</p>`;
                } else {
                    throw new Error('Unexpected API response format');
                }

            } catch (error) {
                console.error('AI Strategy Error:', error);
                output.innerHTML = `<p style="color: var(--accent-red);">‚ùå Error: ${error.message}</p>
                    <p style="margin-top: 1rem; color: var(--text-secondary);">Please check:</p>
                    <ul style="margin-left: 1.5rem; color: var(--text-secondary);">
                        <li>Your OpenAI API key is correct (Settings page)</li>
                        <li>You have API credits available</li>
                        <li>Your internet connection is working</li>
                    </ul>
                    <button class="btn btn-primary" onclick="generateAIDebtStrategy()" style="margin-top: 1rem;">Try Again</button>`;
            }
        }

        // ===== FINANCIAL GOALS PAGE =====

        function loadGoalsPage() {
            const content = document.getElementById('goalsContent');
            const goals = JSON.parse(localStorage.getItem('financialGoals') || '[]');
            
            if (goals.length === 0) {
                content.innerHTML = `
                    <div class="chart-card" style="text-align: center; padding: 3rem;">
                        <h3 style="font-size: 1.5rem; margin-bottom: 1rem;">üéØ No Goals Yet</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                            Start tracking your financial milestones! Set goals for emergency funds,
                            house deposits, holidays, or any custom target.
                        </p>
                        <button class="btn btn-primary" onclick="openAddGoalModal()">Create Your First Goal</button>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="card-grid" style="gap: 1.5rem;">';
            
            goals.forEach((goal, index) => {
                const progress = (goal.currentAmount / goal.targetAmount) * 100;
                const progressClamped = Math.min(progress, 100);
                const remaining = goal.targetAmount - goal.currentAmount;
                const icon = getGoalIcon(goal.type);
                
                // Calculate days until target
                const today = new Date();
                const targetDate = new Date(goal.targetDate);
                const daysRemaining = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
                
                // Determine progress color
                let progressColor = 'var(--accent-green)';
                if (progress < 25) progressColor = 'var(--accent-red)';
                else if (progress < 50) progressColor = 'var(--accent-yellow)';
                else if (progress < 75) progressColor = 'var(--accent-blue)';
                
                // Determine status message
                let statusMessage = '';
                if (progress >= 100) {
                    statusMessage = 'üéâ Goal Achieved!';
                } else if (daysRemaining < 0) {
                    statusMessage = `‚ö†Ô∏è ${Math.abs(daysRemaining)} days overdue`;
                } else if (daysRemaining < 30) {
                    statusMessage = `‚ö° ${daysRemaining} days left`;
                } else {
                    statusMessage = `üìÖ ${daysRemaining} days to go`;
                }
                
                html += `
                    <div class="chart-card" style="position: relative; overflow: hidden;">
                        <!-- Progress Circle Background -->
                        <div style="display: flex; gap: 2rem; align-items: center;">
                            <!-- Circular Progress Ring -->
                            <div style="position: relative; width: 120px; height: 120px; flex-shrink: 0;">
                                <svg width="120" height="120" style="transform: rotate(-90deg);">
                                    <!-- Background circle -->
                                    <circle cx="60" cy="60" r="50" fill="none" 
                                            stroke="rgba(255,255,255,0.1)" stroke-width="10"/>
                                    <!-- Progress circle -->
                                    <circle cx="60" cy="60" r="50" fill="none" 
                                            stroke="${progressColor}" stroke-width="10"
                                            stroke-dasharray="${(progressClamped / 100) * 314} 314"
                                            stroke-linecap="round"
                                            style="transition: stroke-dasharray 0.5s ease;"/>
                                </svg>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                                            text-align: center;">
                                    <div style="font-size: 1.75rem;">${icon}</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: ${progressColor};">
                                        ${progressClamped.toFixed(0)}%
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Goal Details -->
                            <div style="flex: 1;">
                                <h3 style="font-size: 1.25rem; margin-bottom: 0.5rem; color: var(--text-primary);">
                                    ${goal.name}
                                </h3>
                                ${goal.description ? `<p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.75rem;">${goal.description}</p>` : ''}
                                
                                <div style="display: flex; gap: 2rem; margin-bottom: 1rem;">
                                    <div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Current</div>
                                        <div style="font-size: 1.1rem; font-weight: 600; color: var(--accent-green);">
                                            ¬£${goal.currentAmount.toFixed(2)}
                                        </div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Target</div>
                                        <div style="font-size: 1.1rem; font-weight: 600;">
                                            ¬£${goal.targetAmount.toFixed(2)}
                                        </div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Remaining</div>
                                        <div style="font-size: 1.1rem; font-weight: 600; color: ${remaining > 0 ? 'var(--accent-yellow)' : 'var(--accent-green)'};">
                                            ¬£${Math.max(0, remaining).toFixed(2)}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Progress Bar (Linear) -->
                                <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); 
                                            border-radius: 4px; overflow: hidden; margin-bottom: 1rem;">
                                    <div style="width: ${progressClamped}%; height: 100%; background: ${progressColor}; 
                                                transition: width 0.5s ease;"></div>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 0.9rem; color: var(--text-secondary);">
                                        ${statusMessage}
                                    </span>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn btn-primary btn-small" onclick="openEditGoalModal(${index})">
                                            üí∞ Update
                                        </button>
                                        <button class="btn btn-danger btn-small" onclick="deleteGoal(${index})">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Add summary statistics
            const totalTarget = goals.reduce((sum, g) => sum + g.targetAmount, 0);
            const totalSaved = goals.reduce((sum, g) => sum + g.currentAmount, 0);
            const overallProgress = (totalSaved / totalTarget) * 100;
            const goalsCompleted = goals.filter(g => g.currentAmount >= g.targetAmount).length;
            
            html += `
                <div class="chart-card" style="margin-top: 2rem;">
                    <h3 class="chart-title">Goals Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                        <div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Total Goals</div>
                            <div style="font-size: 2rem; font-weight: 700;">${goals.length}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Goals Completed</div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent-green);">${goalsCompleted}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Total Target</div>
                            <div style="font-size: 2rem; font-weight: 700;">¬£${totalTarget.toFixed(0)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Total Saved</div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent-green);">¬£${totalSaved.toFixed(0)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Overall Progress</div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent-blue);">${overallProgress.toFixed(0)}%</div>
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
        }

        function getGoalIcon(type) {
            const icons = {
                'Emergency Fund': 'üõ°Ô∏è',
                'House Deposit': 'üè†',
                'Car': 'üöó',
                'Holiday': '‚úàÔ∏è',
                'Debt Payoff': 'üí≥',
                'Wedding': 'üíç',
                'Education': 'üìö',
                'Custom': '‚ú®'
            };
            return icons[type] || 'üéØ';
        }

        function openAddGoalModal() {
            console.log('Opening Add Goal modal');
            const modal = document.getElementById('addGoalModal');
            modal.classList.add('active');
            
            // Reset form first
            document.getElementById('goalType').value = 'Emergency Fund';
            document.getElementById('goalCustomName').value = '';
            document.getElementById('goalTargetAmount').value = '';
            document.getElementById('goalCurrentAmount').value = '0';
            document.getElementById('goalTargetDate').value = '';
            document.getElementById('goalDescription').value = '';
            document.getElementById('customGoalName').style.display = 'none';
        }

        // Setup goal type change listener on page load

        function addGoal(event) {
            event.preventDefault();
            console.log('Add Goal submitted');
            
            try {
            const type = document.getElementById('goalType').value;
            const customName = document.getElementById('goalCustomName').value;
            const targetAmount = parseFloat(document.getElementById('goalTargetAmount').value);
            const currentAmount = parseFloat(document.getElementById('goalCurrentAmount').value);
            const targetDate = document.getElementById('goalTargetDate').value;
            const description = document.getElementById('goalDescription').value;
            
            const goalName = type === 'Custom' ? customName : type;
            
            const goals = JSON.parse(localStorage.getItem('financialGoals') || '[]');
            
            const newGoal = {
                type: type,
                name: goalName,
                targetAmount: targetAmount,
                currentAmount: currentAmount,
                targetDate: targetDate,
                description: description,
                createdAt: new Date().toISOString()
            };
            
            console.log('Creating goal:', newGoal);
            
            goals.push(newGoal);
            localStorage.setItem('financialGoals', JSON.stringify(goals));
            autoSaveToCloud('financialGoals', JSON.stringify(goals));
            
            closeModal('addGoalModal');
            alert(`‚úÖ Goal created: ${goalName} - ¬£${targetAmount.toFixed(2)}`);
            
            // Reset form
            document.getElementById('goalType').value = 'Emergency Fund';
            document.getElementById('goalCustomName').value = '';
            document.getElementById('goalTargetAmount').value = '';
            document.getElementById('goalCurrentAmount').value = '0';
            document.getElementById('goalTargetDate').value = '';
            document.getElementById('goalDescription').value = '';
            document.getElementById('customGoalName').style.display = 'none';
            
            loadGoalsPage();
            
            } catch (error) {
                console.error('Error creating goal:', error);
                alert('‚ùå Error creating goal. Check console for details.');
            }
        }

        function openEditGoalModal(index) {
            const goals = JSON.parse(localStorage.getItem('financialGoals') || '[]');
            const goal = goals[index];
            
            document.getElementById('editGoalIndex').value = index;
            document.getElementById('editGoalAmount').value = goal.currentAmount;
            document.getElementById('editGoalModal').classList.add('active');
        }

        function updateGoalProgress(event) {
            event.preventDefault();
            
            const index = parseInt(document.getElementById('editGoalIndex').value);
            const newAmount = parseFloat(document.getElementById('editGoalAmount').value);
            
            const goals = JSON.parse(localStorage.getItem('financialGoals') || '[]');
            const oldAmount = goals[index].currentAmount;
            goals[index].currentAmount = newAmount;
            goals[index].lastUpdated = new Date().toISOString();
            
            localStorage.setItem('financialGoals', JSON.stringify(goals));
            
            closeModal('editGoalModal');
            
            const difference = newAmount - oldAmount;
            if (difference > 0) {
                alert(`üéâ Progress updated! Added ¬£${difference.toFixed(2)} to your goal!`);
            } else {
                alert(`‚úÖ Goal amount updated to ¬£${newAmount.toFixed(2)}`);
            }
            
            loadGoalsPage();
        }

        function deleteGoal(index) {
            const goals = JSON.parse(localStorage.getItem('financialGoals') || '[]');
            const goal = goals[index];
            
            if (!confirm(`Delete goal "${goal.name}"?\n\nThis cannot be undone.`)) {
                return;
            }
            
            goals.splice(index, 1);
            localStorage.setItem('financialGoals', JSON.stringify(goals));
            
            alert(`‚úÖ Goal "${goal.name}" deleted`);
            loadGoalsPage();
        }

        // ===== AI INSIGHTS PAGE =====

        function loadInsightsPage() {
            const content = document.getElementById('insightsContent');
            
            let html = `
                <!-- Comprehensive Financial Analysis -->
                <div class="chart-card" style="background: linear-gradient(135deg, rgba(0, 255, 163, 0.1), rgba(0, 153, 255, 0.1)); border: 2px solid var(--accent-green);">
                    <h3 class="chart-title">üí° Comprehensive Financial Analysis</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                        AI analyzes your complete financial picture: income, expenses, debt, and spending patterns to provide personalized recommendations.
                    </p>
                    <button class="btn btn-primary" onclick="generateComprehensiveAnalysis()">
                        ü§ñ Generate Full Financial Analysis
                    </button>
                    <div id="comprehensiveAnalysisOutput" class="mt-2"></div>
                </div>

                <!-- 2026 Predictions -->
                <div class="chart-card" style="background: linear-gradient(135deg, rgba(0, 153, 255, 0.1), rgba(255, 217, 61, 0.1)); border: 2px solid var(--accent-blue);">
                    <h3 class="chart-title">üîÆ 2026 Financial Predictions</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                        AI predicts your 2026 finances based on UK economic trends, salary forecasts, inflation, tax changes, and government policy.
                    </p>
                    <button class="btn btn-primary" onclick="generate2026Predictions()">
                        üîÆ Predict 2026 Finances (with UK trends)
                    </button>
                    <div id="predictions2026Output" class="mt-2"></div>
                </div>

                <!-- Savings Opportunities -->
                <div class="chart-card">
                    <h3 class="chart-title">üí∞ AI Savings Finder</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                        AI identifies specific areas where you can cut costs and save money each month.
                    </p>
                    <button class="btn btn-primary" onclick="generateSavingsOpportunities()">
                        üí° Find Savings Opportunities
                    </button>
                    <div id="savingsOutput" class="mt-2"></div>
                </div>
            `;
            
            content.innerHTML = html;
        }

        async function generateComprehensiveAnalysis() {
            const apiKey = localStorage.getItem('openaiKey');
            if (!apiKey) {
                alert('‚ùå Please add your OpenAI API key in Settings first');
                return;
            }

            const output = document.getElementById('comprehensiveAnalysisOutput');
            output.innerHTML = '<div style="text-align: center; padding: 2rem;"><div style="border: 4px solid var(--border); border-top-color: var(--accent-green); border-radius: 50%; width: 48px; height: 48px; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div><p>AI is performing deep financial analysis...</p></div>';

            const data = FINANCE_DATA[currentYear];
            
            // Calculate all financial metrics
            let totalIncome = 0;
            if (data.income && data.income.items) {
                data.income.items.forEach(item => totalIncome += item.total);
            }

            let totalExpenses = 0;
            let expensesByCategory = {};
            Object.entries(data.expenses).forEach(([category, items]) => {
                let categoryTotal = 0;
                items.forEach(item => {
                    totalExpenses += item.total;
                    categoryTotal += item.total;
                });
                expensesByCategory[category] = categoryTotal;
            });

            // Sort expenses by amount
            const topExpenses = Object.entries(expensesByCategory)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([cat, amount]) => `${cat}: ¬£${amount.toFixed(0)}`)
                .join(', ');

            let totalDebt = 0;
            if (data.debt && data.debt.items) {
                data.debt.items.forEach(item => totalDebt += item.total);
            }

            const monthlyIncome = totalIncome / 12;
            const monthlyExpenses = totalExpenses / 12;
            const deficit = monthlyExpenses - monthlyIncome;

            const personalContext = getPersonalProfileContext();

            const prompt = `As a UK financial advisor, analyze this household's finances and provide actionable insights:
${personalContext}
**Financial Overview (${currentYear}):**
- Annual Income: ¬£${totalIncome.toFixed(2)}
- Annual Expenses: ¬£${totalExpenses.toFixed(2)}
- Net Position: ¬£${(totalIncome - totalExpenses).toFixed(2)} (${deficit > 0 ? 'DEFICIT' : 'SURPLUS'})
- Total Debt: ¬£${totalDebt.toFixed(2)}
- Monthly: ¬£${monthlyIncome.toFixed(2)} income, ¬£${monthlyExpenses.toFixed(2)} expenses

**Top Expense Categories:**
${topExpenses}

**Provide:**
1. **Financial Health Score** (1-10 with explanation)
2. **Top 3 Concerns** (biggest issues to address)
3. **Top 3 Opportunities** (where to save/improve, consider their career transition and side business)
4. **Income Optimization** (specific to their career goals and business growth potential)
5. **Emergency Fund** (how much needed and timeline to build it)
6. **Long-term Strategy** (wealth building for next 5 years, considering career change)

Be specific with numbers and UK context. Consider their unique career situation. Keep under 450 words.`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [
                            { 
                                role: 'system', 
                                content: 'You are an expert UK financial advisor providing personalized, actionable advice.' 
                            },
                            { 
                                role: 'user', 
                                content: prompt 
                            }
                        ],
                        max_tokens: 1000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.choices && result.choices[0] && result.choices[0].message) {
                    const aiResponse = result.choices[0].message.content;
                    output.innerHTML = `<div style="white-space: pre-line; background: rgba(0, 255, 163, 0.05); padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--accent-green); margin-top: 1.5rem;">${aiResponse}</div>
                        <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-secondary);">‚ú® Generated by AI - Always verify advice with a qualified financial advisor</p>`;
                } else {
                    throw new Error('Unexpected API response');
                }

            } catch (error) {
                console.error('Analysis Error:', error);
                output.innerHTML = `<p style="color: var(--accent-red); margin-top: 1.5rem;">‚ùå Error: ${error.message}</p>
                    <button class="btn btn-primary" onclick="generateComprehensiveAnalysis()" style="margin-top: 1rem;">Try Again</button>`;
            }
        }

        async function generate2026Predictions() {
            const apiKey = localStorage.getItem('openaiKey');
            if (!apiKey) {
                alert('‚ùå Please add your OpenAI API key in Settings first');
                return;
            }

            const output = document.getElementById('predictions2026Output');
            output.innerHTML = '<div style="text-align: center; padding: 2rem;"><div style="border: 4px solid var(--border); border-top-color: var(--accent-blue); border-radius: 50%; width: 48px; height: 48px; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div><p>AI is analyzing UK economic trends and forecasting 2026...</p></div>';

            const data = FINANCE_DATA[currentYear];
            
            let totalIncome = 0;
            if (data.income && data.income.items) {
                data.income.items.forEach(item => totalIncome += item.total);
            }

            let totalExpenses = 0;
            Object.values(data.expenses).forEach(category => {
                category.forEach(item => totalExpenses += item.total);
            });

            const personalContext = getPersonalProfileContext();

            const prompt = `As a UK economist, predict 2026 finances for this household:
${personalContext}
**Current 2025 Finances:**
- Annual Income: ¬£${totalIncome.toFixed(2)}
- Annual Expenses: ¬£${totalExpenses.toFixed(2)}

**Your Task:**
Research and apply latest UK forecasts for 2026:
1. **Salary Growth** - Consider their specific career situation (career transition and side business growth potential)
2. **Inflation Impact** - Bank of England CPI predictions for 2026
3. **Tax Changes** - Income tax, NI, council tax confirmed changes
4. **Living Costs** - Energy prices, council tax, transport, food inflation
5. **Interest Rates** - BoE base rate impact on mortgages/debt

**Provide:**
1. **Predicted 2026 Income** (accounting for career change prospects and side business, with % change and reasoning)
2. **Predicted 2026 Expenses** (breakdown by category with % increases)
3. **Net Position Change** (better/worse and by how much)
4. **Recommendations** (specific to their career transition and business growth)
5. **Risk Factors** (what could go wrong, considering career change)

Use real UK economic data and forecasts. Consider their unique situation. Be specific with percentages. Keep under 450 words.`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [
                            { 
                                role: 'system', 
                                content: 'You are a UK economics expert with access to current economic forecasts and government policy.' 
                            },
                            { 
                                role: 'user', 
                                content: prompt 
                            }
                        ],
                        max_tokens: 1000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.choices && result.choices[0] && result.choices[0].message) {
                    const aiResponse = result.choices[0].message.content;
                    output.innerHTML = `<div style="white-space: pre-line; background: rgba(0, 153, 255, 0.05); padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--accent-blue); margin-top: 1.5rem;">${aiResponse}</div>
                        <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-secondary);">‚ú® Based on UK economic forecasts - actual results may vary</p>`;
                } else {
                    throw new Error('Unexpected API response');
                }

            } catch (error) {
                console.error('Prediction Error:', error);
                output.innerHTML = `<p style="color: var(--accent-red); margin-top: 1.5rem;">‚ùå Error: ${error.message}</p>
                    <button class="btn btn-primary" onclick="generate2026Predictions()" style="margin-top: 1rem;">Try Again</button>`;
            }
        }

        async function generateSavingsOpportunities() {
            const apiKey = localStorage.getItem('openaiKey');
            if (!apiKey) {
                alert('‚ùå Please add your OpenAI API key in Settings first');
                return;
            }

            const output = document.getElementById('savingsOutput');
            output.innerHTML = '<div style="text-align: center; padding: 2rem;"><div style="border: 4px solid var(--border); border-top-color: var(--accent-green); border-radius: 50%; width: 48px; height: 48px; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div><p>AI is finding savings opportunities...</p></div>';

            const data = FINANCE_DATA[currentYear];
            
            let expenseBreakdown = '';
            Object.entries(data.expenses).forEach(([category, items]) => {
                let categoryTotal = 0;
                items.forEach(item => categoryTotal += item.total);
                expenseBreakdown += `${category}: ¬£${categoryTotal.toFixed(0)}\n`;
            });

            const prompt = `As a UK money-saving expert, find specific savings opportunities:

**Current Expenses:**
${expenseBreakdown}

**Find:**
1. **Top 5 Savings Opportunities** (specific, actionable changes)
2. **Monthly Savings Potential** (¬£ amount for each)
3. **Implementation Difficulty** (Easy/Medium/Hard for each)
4. **UK-Specific Tips** (comparison sites, switching services, deals)
5. **Total Potential Savings** (monthly and annual)

Be specific - name actual services, websites, and strategies. Focus on UK market. Keep under 350 words.`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            { 
                                role: 'system', 
                                content: 'You are a UK money-saving expert familiar with comparison sites and best deals.' 
                            },
                            { 
                                role: 'user', 
                                content: prompt 
                            }
                        ],
                        max_tokens: 800,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.choices && result.choices[0] && result.choices[0].message) {
                    const aiResponse = result.choices[0].message.content;
                    output.innerHTML = `<div style="white-space: pre-line; background: rgba(0, 255, 163, 0.05); padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--accent-green); margin-top: 1.5rem;">${aiResponse}</div>`;
                } else {
                    throw new Error('Unexpected API response');
                }

            } catch (error) {
                console.error('Savings Error:', error);
                output.innerHTML = `<p style="color: var(--accent-red); margin-top: 1.5rem;">‚ùå Error: ${error.message}</p>
                    <button class="btn btn-primary" onclick="generateSavingsOpportunities()" style="margin-top: 1rem;">Try Again</button>`;
            }
        }

        // ===== MODAL FUNCTIONS =====

        function openAddIncomeModal() {
            // Set current month and year as defaults
            document.getElementById('incomeMonth').value = currentMonth;
            document.getElementById('incomeYear').value = currentYear;
            document.getElementById('addIncomeModal').classList.add('active');
        }

        function openAddExpenseModal() {
            // Set current month and year as defaults
            document.getElementById('expenseMonth').value = currentMonth;
            document.getElementById('expenseYear').value = currentYear;
            
            // Reset payment type to cash
            document.querySelector('input[name="paymentType"][value="cash"]').checked = true;
            updatePaymentOptions();
            
            // Populate debt dropdowns
            populateDebtDropdowns('creditCardDebt');
            populateDebtDropdowns('debtPaymentTarget');
            
            document.getElementById('addExpenseModal').classList.add('active');
        }

        function openAddDebtModal() {
            document.getElementById('debtYear').value = currentYear;
            document.getElementById('addDebtModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            // Reset form
            const modal = document.getElementById(modalId);
            const form = modal.querySelector('form');
            if (form) form.reset();
        }

        function addIncome(event) {
            event.preventDefault();
            
            const name = document.getElementById('incomeName').value.trim();
            const amount = parseFloat(document.getElementById('incomeAmount').value);
            const month = parseInt(document.getElementById('incomeMonth').value);
            const year = parseInt(document.getElementById('incomeYear').value);
            
            console.log('Adding income:', { name, amount, month, year });
            
            // Ensure year data exists
            if (!FINANCE_DATA[year]) {
                FINANCE_DATA[year] = {
                    expenses: {},
                    income: { items: [] },
                    debt: { items: [] }
                };
            }
            
            if (!FINANCE_DATA[year].income.items) {
                FINANCE_DATA[year].income.items = [];
            }
            
            // Find existing income source or create new
            let incomeItem = FINANCE_DATA[year].income.items.find(i => i.name === name);
            
            if (!incomeItem) {
                // Create new income source
                incomeItem = {
                    name: name,
                    monthly: Array(12).fill(0),
                    total: 0
                };
                FINANCE_DATA[year].income.items.push(incomeItem);
                console.log('Created new income source:', name);
            }
            
            // Update the specific month
            incomeItem.monthly[month] = amount;
            
            // Recalculate total
            incomeItem.total = incomeItem.monthly.reduce((sum, val) => sum + val, 0);
            
            console.log('Income updated:', incomeItem);
            
            // Save data
            saveData();
            
            // Close modal
            closeModal('addIncomeModal');
            
            // Show success message
            alert(`‚úÖ Income added: ${name} - ¬£${amount.toFixed(2)} for ${getMonthName(month)} ${year}`);
            
            // Reload current page
            loadPageContent('monthly');
        }

        function addExpense(event) {
            event.preventDefault();
            
            const category = document.getElementById('expenseCategory').value;
            const name = document.getElementById('expenseName').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const month = parseInt(document.getElementById('expenseMonth').value);
            const year = parseInt(document.getElementById('expenseYear').value);
            const isRecurring = document.getElementById('expenseRecurring').checked;
            
            // Get payment method
            const paymentType = document.querySelector('input[name="paymentType"]:checked').value;
            let debtLink = null;
            
            console.log('Adding expense:', { category, name, amount, month, year, isRecurring, paymentType });
            
            // Ensure year data exists
            if (!FINANCE_DATA[year]) {
                FINANCE_DATA[year] = {
                    expenses: {},
                    income: { items: [] },
                    debt: { items: [] }
                };
            }
            
            // Ensure category exists
            if (!FINANCE_DATA[year].expenses[category]) {
                FINANCE_DATA[year].expenses[category] = [];
            }
            
            // Find existing expense or create new
            let expenseItem = FINANCE_DATA[year].expenses[category].find(i => i.name === name);
            
            if (!expenseItem) {
                // Create new expense item
                expenseItem = {
                    name: name,
                    monthly: Array(12).fill(0),
                    total: 0,
                    isRecurring: isRecurring
                };
                FINANCE_DATA[year].expenses[category].push(expenseItem);
                console.log('Created new expense:', name);
            }
            
            // Handle payment method / debt linking
            if (paymentType === 'creditCard') {
                const debtIndex = document.getElementById('creditCardDebt').value;
                if (debtIndex !== '') {
                    const debtIndexInt = parseInt(debtIndex);
                    debtLink = { type: 'creditCard', debtIndex: debtIndexInt };
                    
                    // IMMEDIATELY add to debt when using credit card
                    if (FINANCE_DATA[year].debt && FINANCE_DATA[year].debt.items[debtIndexInt]) {
                        FINANCE_DATA[year].debt.items[debtIndexInt].total += amount;
                        FINANCE_DATA[year].debt.items[debtIndexInt].monthly[month] += amount;
                        trackDebtTransaction(year, month, debtIndexInt, amount, 'charge');
                        console.log(`üí≥ Added ¬£${amount} to debt: ${FINANCE_DATA[year].debt.items[debtIndexInt].name}`);
                    }
                }
            } else if (paymentType === 'debtPayment') {
                const debtIndex = document.getElementById('debtPaymentTarget').value;
                if (debtIndex !== '') {
                    debtLink = { type: 'debtPayment', debtIndex: parseInt(debtIndex) };
                    console.log('üí∞ Linked as debt payment - will reduce debt when marked paid');
                }
            }
            
            // Update the specific month
            expenseItem.monthly[month] = amount;
            
            // Save debt link to expense item
            if (debtLink) {
                expenseItem.debtLink = debtLink;
            }
            
            // Recalculate total
            expenseItem.total = expenseItem.monthly.reduce((sum, val) => sum + val, 0);
            
            console.log('Expense updated:', expenseItem);
            
            // If recurring, add to recurring expenses list
            if (isRecurring) {
                const recurringExpenses = JSON.parse(localStorage.getItem('recurringExpenses') || '[]');
                
                // Check if already in list
                const existing = recurringExpenses.find(e => 
                    e.name === name && e.category === category
                );
                
                if (!existing) {
                    recurringExpenses.push({
                        name: name,
                        category: category,
                        avgAmount: amount,
                        isRecurring: true
                    });
                    localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
                    console.log('Added to recurring expenses list');
                }
            }
            
            // Save data
            saveData();
            
            // Close modal
            closeModal('addExpenseModal');
            
            // Show success message
            const recurringMsg = isRecurring ? ' (will auto-populate future months)' : '';
            let paymentMsg = '';
            if (paymentType === 'creditCard' && debtLink) {
                const debtName = FINANCE_DATA[year].debt.items[debtLink.debtIndex].name;
                paymentMsg = `\nüí≥ Added ¬£${amount.toFixed(2)} to ${debtName}`;
            } else if (paymentType === 'debtPayment' && debtLink) {
                const debtName = FINANCE_DATA[year].debt.items[debtLink.debtIndex].name;
                paymentMsg = `\nüí∞ Linked as payment for ${debtName} (will reduce when marked paid)`;
            }
            
            alert(`‚úÖ Expense added: ${name} - ¬£${amount.toFixed(2)} for ${getMonthName(month)} ${year}${recurringMsg}${paymentMsg}`);
            
            // Reload current page
            loadPageContent('monthly');
        }

        function addDebt(event) {
            event.preventDefault();
            
            const name = document.getElementById('debtName').value.trim();
            const amount = parseFloat(document.getElementById('debtAmount').value);
            const interestRate = document.getElementById('debtInterestRate').value.trim();
            const year = parseInt(document.getElementById('debtYear').value);
            
            console.log('Adding debt:', { name, amount, interestRate, year });
            
            // Ensure year data exists
            if (!FINANCE_DATA[year]) {
                FINANCE_DATA[year] = {
                    expenses: {},
                    income: { items: [] },
                    debt: { items: [] }
                };
            }
            
            if (!FINANCE_DATA[year].debt.items) {
                FINANCE_DATA[year].debt.items = [];
            }
            
            // Check if debt already exists
            const existingDebt = FINANCE_DATA[year].debt.items.find(d => d.name === name);
            if (existingDebt) {
                alert('‚ùå A debt with this name already exists. Please use a different name or edit the existing one.');
                return;
            }
            
            // Create new debt item
            const debtItem = {
                name: name,
                total: amount,
                interestRate: interestRate,
                monthly: Array(12).fill(0)
            };
            
            FINANCE_DATA[year].debt.items.push(debtItem);
            console.log('Debt added:', debtItem);
            
            // Save data
            saveData();
            
            // Close modal
            closeModal('addDebtModal');
            
            // Show success message
            alert(`‚úÖ Debt added: ${name} - ¬£${amount.toFixed(2)} at ${interestRate}%`);
            
            // Reload debt page
            loadDebtPage();
        }

        function editDebt(debtIndex) {
            const data = FINANCE_DATA[currentYear];
            if (!data || !data.debt || !data.debt.items) return;
            
            const item = data.debt.items[debtIndex];
            if (!item) return;
            
            // Populate edit form
            document.getElementById('editDebtIndex').value = debtIndex;
            document.getElementById('editDebtName').value = item.name;
            document.getElementById('editDebtAmount').value = item.total;
            document.getElementById('editDebtInterestRate').value = item.interestRate || getEstimatedInterestRate(item.name);
            
            // Open edit modal
            document.getElementById('editDebtModal').classList.add('active');
        }

        function updateDebt(event) {
            event.preventDefault();
            
            const debtIndex = parseInt(document.getElementById('editDebtIndex').value);
            const newName = document.getElementById('editDebtName').value.trim();
            const newAmount = parseFloat(document.getElementById('editDebtAmount').value);
            const newInterestRate = document.getElementById('editDebtInterestRate').value.trim();
            
            const data = FINANCE_DATA[currentYear];
            if (!data || !data.debt || !data.debt.items) return;
            
            const item = data.debt.items[debtIndex];
            if (!item) return;
            
            // Check if new name already exists (but not the current item)
            const existingDebt = data.debt.items.find((d, idx) => d.name === newName && idx !== debtIndex);
            if (existingDebt) {
                alert('‚ùå A debt with this name already exists. Please use a different name.');
                return;
            }
            
            console.log('Updating debt:', { 
                old: { name: item.name, amount: item.total, rate: item.interestRate },
                new: { name: newName, amount: newAmount, rate: newInterestRate }
            });
            
            // Update all fields
            item.name = newName;
            item.total = newAmount;
            item.interestRate = newInterestRate;
            
            console.log('‚úÖ Debt updated:', item);
            
            // Save data
            saveData();
            
            // Close modal
            closeModal('editDebtModal');
            
            // Show success message
            alert(`‚úÖ Debt updated successfully!`);
            
            // Reload debt page
            loadDebtPage();
        }

        function deleteDebt(debtIndex) {
            const data = FINANCE_DATA[currentYear];
            if (!data || !data.debt || !data.debt.items) return;
            
            const item = data.debt.items[debtIndex];
            if (!item) return;
            
            const confirmDelete = confirm(`Are you sure you want to delete this debt?\n\n${item.name} - ¬£${item.total.toFixed(2)}\n\nThis action cannot be undone.`);
            
            if (!confirmDelete) return;
            
            console.log('Deleting debt:', item);
            
            // Remove the debt
            data.debt.items.splice(debtIndex, 1);
            
            console.log('‚úÖ Debt deleted');
            
            // Save data
            saveData();
            
            // Show success message
            alert(`‚úÖ Deleted: ${item.name}`);
            
            // Reload debt page
            loadDebtPage();
        }

        function getMonthName(monthIndex) {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            return months[monthIndex];
        }

        // ===== EDIT AMOUNT FUNCTIONS =====

        function editExpenseAmount(category, itemName, month, year) {
            const data = FINANCE_DATA[year];
            if (!data || !data.expenses[category]) return;
            
            const item = data.expenses[category].find(i => i.name === itemName);
            if (!item) return;
            
            const currentAmount = item.monthly[month];
            const newAmount = prompt(
                `Edit amount for ${itemName} in ${getMonthName(month)} ${year}:`,
                currentAmount.toFixed(2)
            );
            
            if (newAmount === null) return; // User cancelled
            
            const parsedAmount = parseFloat(newAmount);
            
            if (isNaN(parsedAmount) || parsedAmount < 0) {
                alert('‚ùå Please enter a valid positive number');
                return;
            }
            
            console.log('Editing expense:', { category, itemName, month, year, oldAmount: currentAmount, newAmount: parsedAmount });
            
            // Update the amount
            item.monthly[month] = parsedAmount;
            
            // Recalculate total
            item.total = item.monthly.reduce((sum, val) => sum + val, 0);
            
            console.log('‚úÖ Expense updated:', item);
            
            // Save data
            saveData();
            
            // Show success message
            alert(`‚úÖ Updated ${itemName}: ¬£${currentAmount.toFixed(2)} ‚Üí ¬£${parsedAmount.toFixed(2)}`);
            
            // Reload monthly view
            loadMonthlyView();
        }

        function editIncomeAmount(itemName, month, year) {
            const data = FINANCE_DATA[year];
            if (!data || !data.income || !data.income.items) return;
            
            const item = data.income.items.find(i => i.name === itemName);
            if (!item) return;
            
            const currentAmount = item.monthly[month] || 0;
            const newAmount = prompt(
                `Edit amount for ${itemName} in ${getMonthName(month)} ${year}:`,
                currentAmount.toFixed(2)
            );
            
            if (newAmount === null) return; // User cancelled
            
            const parsedAmount = parseFloat(newAmount);
            
            if (isNaN(parsedAmount) || parsedAmount < 0) {
                alert('‚ùå Please enter a valid positive number');
                return;
            }
            
            console.log('Editing income:', { itemName, month, year, oldAmount: currentAmount, newAmount: parsedAmount });
            
            // Update the amount
            item.monthly[month] = parsedAmount;
            
            // Recalculate total
            item.total = item.monthly.reduce((sum, val) => sum + val, 0);
            
            console.log('‚úÖ Income updated:', item);
            
            // Save data
            saveData();
            
            // Show success message
            alert(`‚úÖ Updated ${itemName}: ¬£${currentAmount.toFixed(2)} ‚Üí ¬£${parsedAmount.toFixed(2)}`);
            
            // Reload monthly view
            loadMonthlyView();
        }

        function deleteIncome(itemName, month, year) {
            if (!confirm(`Delete ${itemName} income for ${getMonthName(month)} ${year}?\n\nThis will set the amount to ¬£0 for this month.`)) {
                return;
            }
            
            const data = FINANCE_DATA[year];
            if (!data || !data.income || !data.income.items) return;
            
            const item = data.income.items.find(i => i.name === itemName);
            if (!item) return;
            
            const deletedAmount = item.monthly[month];
            
            // Set to 0 for this month
            item.monthly[month] = 0;
            
            // Recalculate total
            item.total = item.monthly.reduce((sum, val) => sum + val, 0);
            
            // Save data
            saveData();
            
            alert(`‚úÖ Deleted ${itemName} (¬£${deletedAmount.toFixed(2)}) for ${getMonthName(month)}`);
            
            // Reload
            loadMonthlyView();
        }

        function deleteExpense(category, itemName, month, year) {
            if (!confirm(`Delete ${itemName} expense for ${getMonthName(month)} ${year}?\n\nThis will set the amount to ¬£0 for this month.`)) {
                return;
            }
            
            const data = FINANCE_DATA[year];
            if (!data || !data.expenses || !data.expenses[category]) return;
            
            const item = data.expenses[category].find(i => i.name === itemName);
            if (!item) return;
            
            const deletedAmount = item.monthly[month];
            
            // Set to 0 for this month
            item.monthly[month] = 0;
            
            // Recalculate total
            item.total = item.monthly.reduce((sum, val) => sum + val, 0);
            
            // Remove from paid tracking if exists
            const paidKey = `paid_${year}_${month}_${category}_${itemName}`;
            localStorage.removeItem(paidKey);
            
            // Save data
            saveData();
            
            alert(`‚úÖ Deleted ${itemName} (¬£${deletedAmount.toFixed(2)}) for ${getMonthName(month)}`);
            
            // Reload
            loadMonthlyView();
        }

        // ===== SETTINGS =====

        function saveOpenAIKey() {
            const key = document.getElementById('openaiKeyInput').value.trim();
            if (!key) {
                alert('‚ùå Please enter an API key');
                return;
            }
            
            if (!key.startsWith('sk-')) {
                alert('‚ùå Invalid API key format. OpenAI keys start with "sk-"');
                return;
            }
            
            localStorage.setItem('openaiKey', key);
            alert('‚úÖ OpenAI API key saved successfully!');
        }

        function savePersonalProfile() {
            const profile = {
                job: document.getElementById('profileJob').value.trim(),
                salary: document.getElementById('profileSalary').value.trim(),
                careerGoals: document.getElementById('profileCareerGoals').value.trim(),
                sideBusiness: document.getElementById('profileSideBusiness').value.trim(),
                location: document.getElementById('profileLocation').value.trim(),
                context: document.getElementById('profileContext').value.trim()
            };
            
            // Validate at least job is filled
            if (!profile.job && !profile.salary) {
                alert('‚ùå Please fill in at least your current job or salary');
                return;
            }
            
            localStorage.setItem('personalProfile', JSON.stringify(profile));
            alert('‚úÖ Personal profile saved! AI will now use this information for personalized advice.');
            console.log('Profile saved:', profile);
        }

        function getPersonalProfileContext() {
            const savedProfile = localStorage.getItem('personalProfile');
            if (!savedProfile) return '';
            
            const profile = JSON.parse(savedProfile);
            
            let context = '\n**Personal Context:**\n';
            if (profile.job) context += `- Current Role: ${profile.job}\n`;
            if (profile.salary) context += `- Salary: ¬£${profile.salary}/year\n`;
            if (profile.careerGoals) context += `- Career Goals: ${profile.careerGoals}\n`;
            if (profile.sideBusiness) context += `- Side Business: ${profile.sideBusiness}\n`;
            if (profile.location) context += `- Location: ${profile.location}\n`;
            if (profile.context) context += `- Additional: ${profile.context}\n`;
            
            return context;
        }

        // ===== GOOGLE DRIVE SYNC =====
        
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
        }

        function gisLoaded() {
            // Wait for google.accounts to be available
            if (typeof google === 'undefined' || !google.accounts) {
                console.log('Google Identity Services not ready, retrying...');
                setTimeout(gisLoaded, 100);
                return;
            }
            
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: '',
                });
                gisInited = true;
                console.log('‚úÖ Google Identity Services initialized');
            } catch (error) {
                console.error('Error initializing GIS:', error);
                setTimeout(gisLoaded, 500);
            }
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                document.getElementById('signoutButton').style.display = 'inline-block';
                document.getElementById('authorizeButton').innerText = '‚úì Connected';
                
                // Try to find existing file or create new
                await findOrCreateDriveFile();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                document.getElementById('signoutButton').style.display = 'none';
                document.getElementById('authorizeButton').innerText = 'üîó Connect Google Drive';
            }
        }

        async function findOrCreateDriveFile() {
            const fileName = 'FinanceIQ_Data.json';
            
            try {
                // Search for existing file
                const response = await gapi.client.drive.files.list({
                    q: `name='${fileName}' and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name)',
                });
                
                const files = response.result.files;
                
                if (files && files.length > 0) {
                    // File exists
                    driveFileId = files[0].id;
                    document.getElementById('syncStatus').innerHTML = '<p style="color: var(--accent-green);">‚úì Connected to existing file</p>';
                    
                    // Load data from Drive
                    await loadFromGoogleDrive();
                } else {
                    // Create new file
                    await createDriveFile(fileName);
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('syncStatus').innerHTML = '<p style="color: var(--accent-red);">Error: ' + error.message + '</p>';
            }
        }

        async function createDriveFile(fileName) {
            const metadata = {
                name: fileName,
                mimeType: 'application/json',
            };
            
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', new Blob([JSON.stringify(FINANCE_DATA)], { type: 'application/json' }));
            
            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                body: form,
            });
            
            const result = await response.json();
            driveFileId = result.id;
            
            document.getElementById('syncStatus').innerHTML = '<p style="color: var(--accent-green);">‚úì New file created and synced</p>';
        }

        async function syncToGoogleDrive() {
            if (!driveFileId) return;
            
            try {
                const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=media`, {
                    method: 'PATCH',
                    headers: new Headers({
                        'Authorization': 'Bearer ' + gapi.client.getToken().access_token,
                        'Content-Type': 'application/json',
                    }),
                    body: JSON.stringify(FINANCE_DATA),
                });
                
                console.log('‚úÖ Synced to Google Drive');
                document.getElementById('syncStatus').innerHTML = '<p style="color: var(--accent-green);">‚úì Last synced: ' + new Date().toLocaleTimeString() + '</p>';
            } catch (error) {
                console.error('Sync error:', error);
            }
        }

        async function loadFromGoogleDrive() {
            if (!driveFileId) return;
            
            try {
                const response = await gapi.client.drive.files.get({
                    fileId: driveFileId,
                    alt: 'media',
                });
                
                FINANCE_DATA = JSON.parse(response.body);
                saveData();
                
                document.getElementById('syncStatus').innerHTML = '<p style="color: var(--accent-green);">‚úì Data loaded from Google Drive</p>';
                initializeDashboard();
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        // ===== MANUAL BACKUP =====
        
        function exportData() {
            console.log('Exporting all data...');
            
            // Gather ALL data from localStorage
            const completeBackup = {
                financeData: FINANCE_DATA,
                financialGoals: JSON.parse(localStorage.getItem('financialGoals') || '[]'),
                recurringExpenses: JSON.parse(localStorage.getItem('recurringExpenses') || '[]'),
                budgets: JSON.parse(localStorage.getItem('budgets') || '{}'),
                personalProfile: JSON.parse(localStorage.getItem('personalProfile') || '{}'),
                debtHistory: JSON.parse(localStorage.getItem('debtHistory') || '{}'),
                openaiKey: localStorage.getItem('openaiKey') || '',
                exportDate: new Date().toISOString(),
                version: '4.0'
            };
            
            const dataStr = JSON.stringify(completeBackup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `FinanceIQ-Complete-Backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert('‚úÖ Complete backup downloaded!\n\nIncludes: Finance data, goals, recurring expenses, budgets, personal profile, and settings.');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Confirm before overwriting
            if (!confirm('‚ö†Ô∏è Import data?\n\nThis will REPLACE all current data with the backup file.\n\nCurrent data will be lost unless you\'ve exported it first.\n\nContinue?')) {
                event.target.value = ''; // Reset file input
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    console.log('Importing backup from:', backup.exportDate);
                    
                    // Restore all data
                    if (backup.financeData) {
                        FINANCE_DATA = backup.financeData;
                        saveData();
                    }
                    
                    if (backup.financialGoals) {
                        localStorage.setItem('financialGoals', JSON.stringify(backup.financialGoals));
                    }
                    
                    if (backup.recurringExpenses) {
                        localStorage.setItem('recurringExpenses', JSON.stringify(backup.recurringExpenses));
                    }
                    
                    if (backup.budgets) {
                        localStorage.setItem('budgets', JSON.stringify(backup.budgets));
                    }
                    
                    if (backup.personalProfile) {
                        localStorage.setItem('personalProfile', JSON.stringify(backup.personalProfile));
                    }
                    
                    if (backup.debtHistory) {
                        localStorage.setItem('debtHistory', JSON.stringify(backup.debtHistory));
                    }
                    
                    if (backup.openaiKey) {
                        localStorage.setItem('openaiKey', backup.openaiKey);
                    }
                    
                    alert(`‚úÖ Data imported successfully!\n\nRestored:\n- Finance data (${Object.keys(backup.financeData || {}).length} years)\n- Goals (${(backup.financialGoals || []).length})\n- Recurring expenses (${(backup.recurringExpenses || []).length})\n- Budgets\n- Personal profile\n- Settings\n\nRefreshing page...`);
                    
                    // Refresh page to reload everything
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                    
                } catch (error) {
                    console.error('Import error:', error);
                    alert('‚ùå Error importing file: ' + error.message + '\n\nMake sure this is a valid FinanceIQ backup file.');
                }
            };
            reader.readAsText(file);
            
            // Reset file input for next time
            event.target.value = '';
        }
    </script>
</body>
</html>
